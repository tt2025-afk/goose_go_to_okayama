<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>宮崎家族旅遊規劃</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        earth: {
                            50: '#fbfaf9',
                            100: '#f5f3f0', // 背景淺色
                            200: '#e8e4de',
                            300: '#d6cec4',
                            400: '#bgb0a0',
                            500: '#9c8e7a', // 主大地色
                            600: '#857662',
                            700: '#6d6050',
                            800: '#5a5044', // 深文字
                            900: '#4a423a',
                        },
                        sage: {
                            100: '#edf2ed',
                            500: '#84a98c', // 綠色點綴
                            600: '#6d8c74',
                        }
                    },
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f5f3f0; /* earth-100 */
            -webkit-tap-highlight-color: transparent;
        }
        /* 隱藏 Scrollbar 但保留功能 */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .date-card.active {
            background-color: #5a5044; /* earth-800 */
            color: white;
            transform: scale(1.05);
        }
        .fab-btn {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body class="text-earth-800 h-screen flex flex-col overflow-hidden max-w-md mx-auto bg-white shadow-2xl relative">

    <!-- Header & Weather -->
    <header class="bg-earth-100 p-6 pb-2 rounded-b-3xl z-10 shadow-sm flex-shrink-0">
        <div class="flex justify-between items-start mb-4">
            <div>
                <h2 class="text-sm text-earth-600 tracking-widest uppercase mb-1">Miyazaki Trip</h2>
                <h1 class="text-2xl font-bold text-earth-900">宮崎家族旅遊</h1>
            </div>
            <div class="bg-white px-3 py-2 rounded-xl shadow-sm flex items-center gap-2">
                <i class="fa-solid fa-sun text-orange-400 text-xl"></i>
                <div>
                    <div class="text-xs text-gray-400">宮崎縣</div>
                    <div class="font-bold text-earth-800" id="weather-temp">29°C</div>
                </div>
            </div>
        </div>

        <!-- Date Slider -->
        <div class="flex overflow-x-auto gap-3 pb-4 hide-scrollbar snap-x" id="date-slider">
            <!-- JavaScript will populate dates -->
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-y-auto p-5 pb-24 relative bg-white" id="main-container">
        
        <!-- View: Itinerary -->
        <div id="view-itinerary" class="block animate-fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg text-earth-800">當日行程</h3>
                <span class="text-xs bg-earth-200 px-2 py-1 rounded text-earth-700" id="current-date-display">8/21 (三)</span>
            </div>
            
            <div class="relative border-l-2 border-earth-200 ml-3 space-y-6" id="itinerary-list">
                <!-- Javascript will populate items -->
            </div>
            
            <!-- Empty State -->
            <div id="empty-itinerary" class="hidden text-center py-10 text-earth-400">
                <i class="fa-regular fa-calendar-plus text-4xl mb-3"></i>
                <p>點擊右下角新增行程</p>
            </div>
        </div>

        <!-- View: Accounting -->
        <div id="view-accounting" class="hidden animate-fade-in">
            <div class="bg-earth-500 text-white p-5 rounded-2xl shadow-lg mb-6">
                <div class="text-earth-100 text-sm mb-1">總支出</div>
                <div class="text-3xl font-bold" id="total-expense">¥0</div>
                <div class="mt-4 flex -space-x-2 overflow-hidden" id="member-avatars">
                    <!-- Avatars -->
                </div>
            </div>

            <div class="flex justify-between items-center mb-2">
                <h3 class="font-bold text-lg text-earth-800">消費紀錄</h3>
                <button onclick="openMemberModal()" class="text-xs text-sage-600 font-bold border border-sage-600 px-2 py-1 rounded hover:bg-sage-100">編輯成員</button>
            </div>

            <div class="space-y-3" id="expense-list">
                <!-- Javascript will populate expenses -->
            </div>
        </div>

    </main>

    <!-- Floating Action Button -->
    <button onclick="handleFabClick()" class="fab-btn absolute bottom-24 right-5 bg-earth-800 text-white w-14 h-14 rounded-full flex items-center justify-center text-xl shadow-lg hover:bg-earth-900 transition-colors z-20">
        <i class="fa-solid fa-plus"></i>
    </button>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 w-full max-w-md bg-white border-t border-earth-200 p-2 pb-6 z-30 flex justify-around rounded-t-2xl shadow-[0_-5px_10px_rgba(0,0,0,0.02)]">
        <button onclick="switchView('itinerary')" class="nav-item w-full py-2 flex flex-col items-center gap-1 text-earth-800 transition-colors" id="nav-itinerary">
            <i class="fa-solid fa-map-location-dot text-xl"></i>
            <span class="text-xs font-medium">行程</span>
        </button>
        <button onclick="switchView('accounting')" class="nav-item w-full py-2 flex flex-col items-center gap-1 text-earth-400 transition-colors" id="nav-accounting">
            <i class="fa-solid fa-wallet text-xl"></i>
            <span class="text-xs font-medium">分帳</span>
        </button>
    </nav>

    <!-- Modal: Add/Edit Itinerary -->
    <div id="modal-itinerary" class="fixed inset-0 bg-black/50 hidden z-50 flex items-end sm:items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 transform translate-y-full transition-transform duration-300" id="modal-itinerary-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-earth-900">新增行程</h3>
                <button onclick="closeModal('modal-itinerary')" class="text-earth-400 hover:text-earth-800"><i class="fa-solid fa-xmark text-2xl"></i></button>
            </div>
            <form id="form-itinerary" class="space-y-4">
                <input type="hidden" id="edit-id">
                <div>
                    <label class="block text-xs font-bold text-earth-500 mb-1">時間</label>
                    <input type="time" id="input-time" class="w-full bg-earth-50 p-3 rounded-xl border-none focus:ring-2 focus:ring-earth-500 outline-none" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-earth-500 mb-1">行程名稱</label>
                    <input type="text" id="input-title" placeholder="例：青島神社" class="w-full bg-earth-50 p-3 rounded-xl border-none focus:ring-2 focus:ring-earth-500 outline-none" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-earth-500 mb-1">地點 (Google Maps 搜尋關鍵字)</label>
                    <div class="relative">
                        <i class="fa-solid fa-location-dot absolute left-4 top-3.5 text-earth-400"></i>
                        <input type="text" id="input-location" placeholder="例：Miyazaki Aoshima" class="w-full bg-earth-50 p-3 pl-10 rounded-xl border-none focus:ring-2 focus:ring-earth-500 outline-none">
                    </div>
                </div>
                <button type="submit" class="w-full bg-earth-800 text-white py-4 rounded-xl font-bold shadow-md hover:bg-earth-900 mt-2">儲存行程</button>
                <button type="button" id="btn-delete-itinerary" class="hidden w-full bg-red-50 text-red-500 py-3 rounded-xl font-bold mt-2">刪除此行程</button>
            </form>
        </div>
    </div>

    <!-- Modal: Add Expense -->
    <div id="modal-expense" class="fixed inset-0 bg-black/50 hidden z-50 flex items-end sm:items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 transform translate-y-full transition-transform duration-300" id="modal-expense-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-earth-900">新增支出</h3>
                <button onclick="closeModal('modal-expense')" class="text-earth-400 hover:text-earth-800"><i class="fa-solid fa-xmark text-2xl"></i></button>
            </div>
            <form id="form-expense" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-earth-500 mb-1">項目</label>
                    <input type="text" id="exp-title" placeholder="例：午餐 - 宮崎牛" class="w-full bg-earth-50 p-3 rounded-xl border-none focus:ring-2 focus:ring-sage-500 outline-none" required>
                </div>
                <div class="flex gap-4">
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-earth-500 mb-1">金額 (¥)</label>
                        <input type="number" id="exp-amount" placeholder="0" class="w-full bg-earth-50 p-3 rounded-xl border-none focus:ring-2 focus:ring-sage-500 outline-none" required>
                    </div>
                    <div class="w-1/3">
                        <label class="block text-xs font-bold text-earth-500 mb-1">日期</label>
                         <select id="exp-date" class="w-full bg-earth-50 p-3 rounded-xl border-none outline-none text-sm">
                            <!-- populated by js -->
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-earth-500 mb-2">分帳成員 (勾選付款人)</label>
                    <div class="grid grid-cols-3 gap-2" id="split-members-container">
                        <!-- populated by js -->
                    </div>
                </div>

                <button type="submit" class="w-full bg-sage-500 text-white py-4 rounded-xl font-bold shadow-md hover:bg-sage-600 mt-2">新增紀錄</button>
            </form>
        </div>
    </div>

    <!-- Modal: Manage Members -->
    <div id="modal-members" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-white w-3/4 max-w-sm rounded-2xl p-6 shadow-2xl transform scale-95 transition-transform duration-300" id="modal-members-content">
            <h3 class="text-lg font-bold text-earth-900 mb-4">編輯成員</h3>
            <div id="members-list" class="space-y-2 mb-4">
                <!-- List -->
            </div>
            <div class="flex gap-2">
                <input type="text" id="new-member-name" placeholder="新成員名字" class="flex-1 bg-earth-50 p-2 rounded border border-earth-200 text-sm">
                <button onclick="addMember()" class="bg-earth-800 text-white px-3 rounded text-sm"><i class="fa-solid fa-plus"></i></button>
            </div>
            <div class="mt-6 text-right">
                <button onclick="closeModal('modal-members')" class="text-earth-600 font-bold text-sm">完成</button>
            </div>
        </div>
    </div>

    <script>
        // --- Data & State ---
        const tripDates = [
            { date: '2025-08-21', label: '8/21', day: '三' },
            { date: '2025-08-22', label: '8/22', day: '四' },
            { date: '2025-08-23', label: '8/23', day: '五' },
            { date: '2025-08-24', label: '8/24', day: '六' },
        ];

        // Initial Data (Simulated DB)
        const defaultItinerary = [
            { id: 1, date: '2025-08-21', time: '10:00', title: '抵達宮崎機場', location: 'Miyazaki Airport' },
            { id: 2, date: '2025-08-21', time: '12:30', title: '午餐：宮崎牛', location: 'Miyazaki Beef Teppanyaki' },
            { id: 3, date: '2025-08-21', time: '14:30', title: '青島神社 & 鬼之洗衣板', location: 'Aoshima Shrine' },
            { id: 4, date: '2025-08-22', time: '09:00', title: '出發前往高千穗', location: 'Takachiho Gorge' },
            { id: 5, date: '2025-08-22', time: '11:00', title: '高千穗峽划船', location: 'Takachiho Gorge Boat Rental' },
            { id: 6, date: '2025-08-23', time: '10:00', title: '鵜戶神宮', location: 'Udo Shrine' },
            { id: 7, date: '2025-08-23', time: '15:00', title: 'Sun Messe 日南 (摩艾石像)', location: 'Sun Messe Nichinan' },
        ];

        const defaultMembers = ['媽媽', '大哥', '小毛', '翔哥', '筱葳', '耀哥', '筱婷', '寧寧', '志愷'];

        // App State
        let state = {
            currentDate: tripDates[0].date,
            currentView: 'itinerary', // 'itinerary' or 'accounting'
            itinerary: JSON.parse(localStorage.getItem('my_trip_itinerary')) || defaultItinerary,
            expenses: JSON.parse(localStorage.getItem('my_trip_expenses')) || [],
            members: JSON.parse(localStorage.getItem('my_trip_members')) || defaultMembers,
        };

        // --- Core Functions ---

        function init() {
            renderDateSlider();
            renderItinerary();
            renderExpenses();
            updateWeather(state.currentDate);
            populateDateSelect();
        }

        function saveData() {
            localStorage.setItem('my_trip_itinerary', JSON.stringify(state.itinerary));
            localStorage.setItem('my_trip_expenses', JSON.stringify(state.expenses));
            localStorage.setItem('my_trip_members', JSON.stringify(state.members));
            renderItinerary(); // Re-render to reflect changes
            renderExpenses();
        }

        // --- Weather Simulation ---
        function updateWeather(dateStr) {
            // Mock weather logic for Miyazaki in August (Hot!)
            // Using hash of date string to keep result consistent per day
            const hash = dateStr.split('').reduce((a,b)=>{a=((a<<5)-a)+b.charCodeAt(0);return a&a},0);
            const temp = 28 + (Math.abs(hash) % 6); // 28-33 degrees
            const conditions = ['fa-sun', 'fa-cloud-sun', 'fa-cloud-showers-heavy'];
            const condIcon = conditions[Math.abs(hash) % 3];
            
            document.getElementById('weather-temp').innerText = `${temp}°C`;
            const iconEl = document.querySelector('.fa-sun, .fa-cloud-sun, .fa-cloud-showers-heavy');
            if(iconEl) {
                iconEl.className = `fa-solid ${condIcon} text-orange-400 text-xl`;
            }
        }

        // --- UI Rendering ---

        function renderDateSlider() {
            const container = document.getElementById('date-slider');
            container.innerHTML = '';
            
            tripDates.forEach(d => {
                const isActive = d.date === state.currentDate;
                const el = document.createElement('div');
                el.className = `date-card flex-shrink-0 w-16 h-20 rounded-2xl flex flex-col items-center justify-center cursor-pointer transition-all duration-300 snap-center ${isActive ? 'active shadow-lg' : 'bg-white text-earth-400 border border-earth-100'}`;
                el.innerHTML = `
                    <span class="text-xs font-medium">${d.label}</span>
                    <span class="text-lg font-bold mt-1">${d.day}</span>
                `;
                el.onclick = () => {
                    state.currentDate = d.date;
                    renderDateSlider(); // Re-render to update styling
                    renderItinerary();
                    updateWeather(d.date);
                    
                    // Update display text
                    const found = tripDates.find(t => t.date === state.currentDate);
                    document.getElementById('current-date-display').innerText = `${found.label} (${found.day})`;
                };
                container.appendChild(el);
            });
        }

        function renderItinerary() {
            const list = document.getElementById('itinerary-list');
            list.innerHTML = '';
            
            // Filter and Sort
            const dailyItems = state.itinerary
                .filter(i => i.date === state.currentDate)
                .sort((a, b) => a.time.localeCompare(b.time));

            if (dailyItems.length === 0) {
                document.getElementById('empty-itinerary').classList.remove('hidden');
            } else {
                document.getElementById('empty-itinerary').classList.add('hidden');
                
                dailyItems.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'relative pl-6 pb-2 group';
                    
                    // Google Maps Link
                    const mapLink = item.location ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}` : '#';
                    
                    el.innerHTML = `
                        <!-- Dot -->
                        <div class="absolute -left-[9px] top-1 w-4 h-4 rounded-full bg-earth-500 border-4 border-white shadow-sm z-10"></div>
                        
                        <!-- Card -->
                        <div class="bg-earth-50 rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow cursor-pointer border border-transparent hover:border-earth-200" onclick="openEditItinerary(${item.id})">
                            <div class="flex justify-between items-start">
                                <span class="text-sage-600 font-bold text-sm bg-sage-100 px-2 py-0.5 rounded-md">${item.time}</span>
                                <a href="${mapLink}" target="_blank" onclick="event.stopPropagation()" class="text-earth-400 hover:text-red-500 transition-colors">
                                    <i class="fa-solid fa-map-location-dot text-lg"></i>
                                </a>
                            </div>
                            <h4 class="font-bold text-earth-900 mt-2 text-lg">${item.title}</h4>
                            ${item.location ? `<p class="text-xs text-earth-500 mt-1"><i class="fa-solid fa-location-dot mr-1"></i>${item.location}</p>` : ''}
                        </div>
                    `;
                    list.appendChild(el);
                });
            }
        }

        function renderExpenses() {
            const list = document.getElementById('expense-list');
            list.innerHTML = '';
            
            let total = 0;
            
            // Sort by date desc
            const sortedExpenses = [...state.expenses].sort((a,b) => b.id - a.id);

            sortedExpenses.forEach(exp => {
                total += parseInt(exp.amount);
                const memberCount = exp.sharedBy.length;
                const perPerson = memberCount > 0 ? Math.round(exp.amount / memberCount) : 0;
                
                const dateObj = tripDates.find(d => d.date === exp.date);
                const dateLabel = dateObj ? dateObj.label : exp.date.substring(5).replace('-', '/');

                const el = document.createElement('div');
                el.className = 'bg-white p-4 rounded-xl shadow-sm border border-earth-100 flex justify-between items-center';
                el.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="bg-sage-100 w-10 h-10 rounded-full flex items-center justify-center text-sage-600">
                            <i class="fa-solid fa-utensils"></i>
                        </div>
                        <div>
                            <div class="font-bold text-earth-800">${exp.title}</div>
                            <div class="text-xs text-earth-400">${dateLabel} • 分攤: ${exp.sharedBy.join(', ')}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-earth-900">¥${parseInt(exp.amount).toLocaleString()}</div>
                        <div class="text-[10px] text-earth-400">每人 ¥${perPerson.toLocaleString()}</div>
                        <button onclick="deleteExpense(${exp.id})" class="text-red-300 text-xs mt-1 hover:text-red-500">刪除</button>
                    </div>
                `;
                list.appendChild(el);
            });

            document.getElementById('total-expense').innerText = `¥${total.toLocaleString()}`;
            
            // Render Avatars
            const avatarContainer = document.getElementById('member-avatars');
            avatarContainer.innerHTML = '';
            state.members.forEach((m, i) => {
                const div = document.createElement('div');
                div.className = `w-8 h-8 rounded-full bg-earth-${((i%3)+2)*100} border-2 border-white flex items-center justify-center text-[10px] font-bold text-earth-800`;
                div.innerText = m.charAt(0);
                avatarContainer.appendChild(div);
            });
        }

        // --- Interaction Handlers ---

        function switchView(viewName) {
            state.currentView = viewName;
            
            // Toggle Content
            document.getElementById('view-itinerary').className = viewName === 'itinerary' ? 'block animate-fade-in' : 'hidden';
            document.getElementById('view-accounting').className = viewName === 'accounting' ? 'block animate-fade-in' : 'hidden';

            // Toggle Nav Active State
            const btnItin = document.getElementById('nav-itinerary');
            const btnAcc = document.getElementById('nav-accounting');
            
            if(viewName === 'itinerary') {
                btnItin.className = 'nav-item w-full py-2 flex flex-col items-center gap-1 text-earth-800 transition-colors';
                btnItin.querySelector('i').className = 'fa-solid fa-map-location-dot text-xl'; // Fill icon?
                btnAcc.className = 'nav-item w-full py-2 flex flex-col items-center gap-1 text-earth-400 transition-colors';
            } else {
                btnItin.className = 'nav-item w-full py-2 flex flex-col items-center gap-1 text-earth-400 transition-colors';
                btnAcc.className = 'nav-item w-full py-2 flex flex-col items-center gap-1 text-earth-800 transition-colors';
            }
        }

        function handleFabClick() {
            if (state.currentView === 'itinerary') {
                openModal('modal-itinerary');
                // Reset form
                document.getElementById('form-itinerary').reset();
                document.getElementById('edit-id').value = '';
                document.getElementById('btn-delete-itinerary').classList.add('hidden');
                // Default time to now or 09:00
                document.getElementById('input-time').value = '09:00';
            } else {
                renderSplitMembers();
                openModal('modal-expense');
                document.getElementById('form-expense').reset();
                document.getElementById('exp-date').value = state.currentDate;
            }
        }

        // Modal Logic
        function openModal(id) {
            const modal = document.getElementById(id);
            const content = document.getElementById(id + '-content');
            modal.classList.remove('hidden');
            // Small delay for CSS transition
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                if(content.classList.contains('translate-y-full')) {
                    content.classList.remove('translate-y-full');
                } else {
                    content.classList.remove('scale-95');
                    content.classList.add('scale-100');
                }
            }, 10);
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            const content = document.getElementById(id + '-content');
            modal.classList.add('opacity-0');
            if(!content.classList.contains('scale-100')) {
                content.classList.add('translate-y-full');
            } else {
                content.classList.remove('scale-100');
                content.classList.add('scale-95');
            }
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // --- Itinerary CRUD ---
        
        document.getElementById('form-itinerary').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const time = document.getElementById('input-time').value;
            const title = document.getElementById('input-title').value;
            const location = document.getElementById('input-location').value;
            
            if (id) {
                // Edit
                const index = state.itinerary.findIndex(i => i.id == id);
                if (index > -1) {
                    state.itinerary[index] = { ...state.itinerary[index], time, title, location };
                }
            } else {
                // Add
                const newItem = {
                    id: Date.now(),
                    date: state.currentDate,
                    time,
                    title,
                    location
                };
                state.itinerary.push(newItem);
            }
            
            saveData();
            closeModal('modal-itinerary');
        });

        function openEditItinerary(id) {
            const item = state.itinerary.find(i => i.id === id);
            if (!item) return;

            document.getElementById('edit-id').value = item.id;
            document.getElementById('input-time').value = item.time;
            document.getElementById('input-title').value = item.title;
            document.getElementById('input-location').value = item.location;
            
            const btnDel = document.getElementById('btn-delete-itinerary');
            btnDel.classList.remove('hidden');
            btnDel.onclick = () => {
                if(confirm('確定刪除此行程？')) {
                    state.itinerary = state.itinerary.filter(i => i.id !== id);
                    saveData();
                    closeModal('modal-itinerary');
                }
            };

            openModal('modal-itinerary');
        }

        // --- Accounting CRUD ---

        function populateDateSelect() {
            const sel = document.getElementById('exp-date');
            sel.innerHTML = '';
            tripDates.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.date;
                opt.text = `${d.label} (${d.day})`;
                sel.appendChild(opt);
            });
        }

        function renderSplitMembers() {
            const container = document.getElementById('split-members-container');
            container.innerHTML = '';
            state.members.forEach(m => {
                const label = document.createElement('label');
                label.className = 'flex items-center space-x-2 bg-earth-50 p-2 rounded cursor-pointer select-none';
                label.innerHTML = `
                    <input type="checkbox" value="${m}" checked class="form-checkbox text-sage-600 rounded focus:ring-sage-500">
                    <span class="text-sm text-earth-800">${m}</span>
                `;
                container.appendChild(label);
            });
        }

        document.getElementById('form-expense').addEventListener('submit', (e) => {
            e.preventDefault();
            const title = document.getElementById('exp-title').value;
            const amount = document.getElementById('exp-amount').value;
            const date = document.getElementById('exp-date').value;
            
            const checkboxes = document.querySelectorAll('#split-members-container input[type="checkbox"]:checked');
            const sharedBy = Array.from(checkboxes).map(cb => cb.value);
            
            if (sharedBy.length === 0) {
                alert('請至少選擇一位分帳成員');
                return;
            }

            const newExp = {
                id: Date.now(),
                title,
                amount,
                date,
                sharedBy
            };

            state.expenses.push(newExp);
            saveData();
            closeModal('modal-expense');
        });

        function deleteExpense(id) {
            if(confirm('確定刪除此筆支出？')) {
                state.expenses = state.expenses.filter(e => e.id !== id);
                saveData();
            }
        }

        // --- Member Management ---
        function openMemberModal() {
            renderMembersList();
            openModal('modal-members');
        }

        function renderMembersList() {
            const list = document.getElementById('members-list');
            list.innerHTML = '';
            state.members.forEach((m, index) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-earth-50 p-2 rounded';
                div.innerHTML = `
                    <span class="text-earth-800">${m}</span>
                    ${state.members.length > 1 ? `<button onclick="removeMember(${index})" class="text-red-400"><i class="fa-solid fa-trash text-xs"></i></button>` : ''}
                `;
                list.appendChild(div);
            });
        }

        function addMember() {
            const input = document.getElementById('new-member-name');
            const name = input.value.trim();
            if (name) {
                state.members.push(name);
                input.value = '';
                saveData(); // Save and re-render app
                renderMembersList(); // Re-render modal list
            }
        }

        function removeMember(index) {
            state.members.splice(index, 1);
            saveData();
            renderMembersList();
        }

        // Initialize
        init();

    </script>
</body>
</html>
