<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å²¡å±±å®¶æ—æ—…éŠ</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        earth: { 50:'#fbfaf9', 100:'#f5f3f0', 200:'#e8e4de', 300:'#d6cec4', 400:'#bgb0a0', 500:'#9c8e7a', 600:'#857662', 700:'#6d6050', 800:'#5a5044', 900:'#4a423a' },
                        sage: { 50:'#f4f7f4', 100:'#edf2ed', 500:'#84a98c', 600:'#6d8c74' },
                        terracotta: { 500: '#e07a5f', 600: '#d06a50' } // é»ç¶´è‰²
                    },
                    fontFamily: { sans: ['Noto Sans TC', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f5f3f0; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .date-card.active { background-color: #5a5044; color: white; transform: scale(1.05); }
        .fab-btn { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        
        /* Checkbox Customization for Packing List */
        .pack-checkbox:checked + div { text-decoration: line-through; color: #bgb0a0; }
        
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(245,243,240,0.95); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s;
        }

        /* Stylized Route Map */
        .route-map { position: relative; width: 100%; height: 120px; background: #e8e4de; border-radius: 1rem; overflow: hidden; margin-top: 1rem; }
        .route-path { position: absolute; top: 50%; left: 10%; right: 10%; height: 4px; background: #9c8e7a; transform: translateY(-50%); border-radius: 2px; }
        .route-node { position: absolute; top: 50%; transform: translate(-50%, -50%); width: 14px; height: 14px; background: white; border: 3px solid #5a5044; border-radius: 50%; z-index: 10; }
        .route-label { position: absolute; top: 65%; transform: translateX(-50%); font-size: 10px; font-weight: bold; color: #5a5044; white-space: nowrap; }
        .node-1 { left: 15%; } .node-2 { left: 40%; } .node-3 { left: 65%; } .node-4 { left: 85%; }
    </style>
</head>
<body class="text-earth-800 h-screen flex flex-col overflow-hidden max-w-md mx-auto bg-white shadow-2xl relative">

    <div id="loading-overlay">
        <i class="fa-solid fa-plane-departure text-4xl text-earth-600 animate-bounce mb-4"></i>
        <p class="text-earth-800 font-bold tracking-widest">OKAYAMA TRIP</p>
        <p class="text-xs text-earth-500 mt-2">è¼‰å…¥è¡Œç¨‹è³‡æ–™ä¸­...</p>
    </div>

    <!-- Header -->
    <header class="bg-earth-100 p-6 pb-2 rounded-b-3xl z-10 shadow-sm flex-shrink-0 relative">
        <div class="flex justify-between items-start mb-4">
            <div>
                <h2 class="text-xs text-earth-600 tracking-widest uppercase mb-1 font-bold">Okayama & Kurashiki</h2>
                <h1 class="text-2xl font-black text-earth-900">å²¡å±±å®¶æ—æ—…éŠ <i class="fa-solid fa-cloud text-xs text-sage-500 ml-1"></i></h1>
            </div>
            <div class="bg-white px-3 py-2 rounded-xl shadow-sm flex items-center gap-2">
                <i class="fa-solid fa-sun text-orange-400 text-xl" id="header-weather-icon"></i>
                <div>
                    <div class="text-xs text-gray-400">å²¡å±±ç¸£</div>
                    <div class="font-bold text-earth-800" id="weather-temp">33Â°C</div>
                </div>
            </div>
        </div>

        <!-- Date Slider (Only visible on Itinerary and Accounting views) -->
        <div class="flex overflow-x-auto gap-3 pb-4 hide-scrollbar snap-x transition-all duration-300" id="date-slider-container">
            <div class="flex gap-3" id="date-slider"></div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-y-auto p-5 pb-24 relative bg-white" id="main-container">
        
        <!-- ================= VIEW: ITINERARY ================= -->
        <div id="view-itinerary" class="block animate-fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg text-earth-800 border-b-2 border-sage-500 pb-1">ç•¶æ—¥è¡Œç¨‹</h3>
                <span class="text-xs bg-earth-200 px-3 py-1 rounded-full text-earth-800 font-bold shadow-sm" id="current-date-display-itin">8/20 (å››)</span>
            </div>
            
            <div class="relative border-l-2 border-earth-200 ml-3 space-y-6" id="itinerary-list">
                <!-- JS populated -->
            </div>
            
            <div id="empty-itinerary" class="hidden text-center py-10 text-earth-400">
                <i class="fa-regular fa-calendar-plus text-4xl mb-3"></i>
                <p>ç„¡è¡Œç¨‹ï¼Œé»æ“Šå³ä¸‹è§’æ–°å¢</p>
            </div>
        </div>

        <!-- ================= VIEW: WEATHER & OVERVIEW ================= -->
        <div id="view-weather" class="hidden animate-fade-in space-y-6">
            <h3 class="font-bold text-lg text-earth-800 border-b-2 border-sage-500 pb-1 mb-4">å¤©æ°£èˆ‡è·¯ç·šç¸½è¦½</h3>
            
            <!-- Route Map Mockup -->
            <div class="bg-earth-50 p-4 rounded-2xl shadow-sm border border-earth-100">
                <h4 class="text-sm font-bold text-earth-700 mb-2"><i class="fa-solid fa-map-location-dot mr-1"></i> è¡Œç¨‹ç§»å‹•è·¯ç·š</h4>
                <div class="route-map">
                    <div class="route-path"></div>
                    <div class="route-node node-1"></div><div class="route-label node-1">å²¡å±±æ©Ÿå ´</div>
                    <div class="route-node node-2"></div><div class="route-label node-2">å²¡å±±å¸‚å€</div>
                    <div class="route-node node-3"></div><div class="route-label node-3">å€‰æ•·(é€£å®¿)</div>
                    <div class="route-node node-4"></div><div class="route-label node-4">é·²ç¾½å±±</div>
                </div>
            </div>

            <!-- Daily Weather Cards -->
            <div class="space-y-3" id="weather-cards-container">
                <!-- JS Populated -->
            </div>
        </div>

        <!-- ================= VIEW: ACCOUNTING ================= -->
        <div id="view-accounting" class="hidden animate-fade-in">
            <div class="bg-earth-500 text-white p-5 rounded-2xl shadow-lg mb-6 relative bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]">
                <div class="flex justify-between items-start relative z-10">
                    <div>
                        <div class="text-earth-100 text-sm mb-1 font-medium">ç¸½è¡Œç¨‹æ”¯å‡º (TWD)</div>
                        <div class="text-3xl font-black tracking-tight" id="total-expense-twd">NT$ 0</div>
                        <div class="text-xs text-earth-200 mt-1 bg-black/20 inline-block px-2 py-0.5 rounded backdrop-blur-sm">åŒ¯ç‡: <span id="display-rate">0.22</span></div>
                    </div>
                    <button onclick="openSettlementModal()" class="bg-white text-earth-800 text-xs font-bold px-3 py-2 rounded-lg shadow-md hover:bg-earth-50 transition-colors flex items-center gap-1">
                        <i class="fa-solid fa-calculator"></i> çµç®—
                    </button>
                </div>
                <div class="mt-4 flex -space-x-2 overflow-hidden relative z-10" id="member-avatars"></div>
            </div>

            <div class="flex justify-between items-center mb-3">
                <div class="flex items-center gap-2">
                    <h3 class="font-bold text-lg text-earth-800 border-b-2 border-sage-500 pb-1">æ¶ˆè²»ç´€éŒ„</h3>
                    <span class="text-xs bg-earth-200 px-3 py-1 rounded-full text-earth-800 font-bold shadow-sm" id="current-date-display-acc">8/20 (å››)</span>
                </div>
                <button onclick="openMemberModal()" class="text-xs text-earth-500 font-bold border border-earth-300 px-2 py-1 rounded hover:bg-earth-100 bg-white shadow-sm"><i class="fa-solid fa-users-gear mr-1"></i>æˆå“¡</button>
            </div>

            <div class="space-y-3" id="expense-list"></div>
            <div id="empty-expenses" class="hidden text-center py-8 text-earth-400 text-sm">
                <i class="fa-solid fa-receipt text-2xl mb-2 opacity-50"></i><p>æœ¬æ—¥å°šç„¡æ¶ˆè²»ç´€éŒ„</p>
            </div>
        </div>

        <!-- ================= VIEW: TOOLS ================= -->
        <div id="view-tools" class="hidden animate-fade-in space-y-6">
            <h3 class="font-bold text-lg text-earth-800 border-b-2 border-sage-500 pb-1 mb-4">è¡Œå‰æº–å‚™èˆ‡å·¥å…·ç›’</h3>

            <!-- Data Hub -->
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-earth-50 p-4 rounded-2xl border border-earth-200 shadow-sm flex flex-col items-center justify-center text-center cursor-pointer hover:bg-earth-100 transition" onclick="openModal('modal-flight')">
                    <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-earth-600 mb-2 shadow-sm"><i class="fa-solid fa-plane-departure text-lg"></i></div>
                    <span class="text-sm font-bold text-earth-800">èˆªç­è³‡è¨Š</span>
                </div>
                <div class="bg-earth-50 p-4 rounded-2xl border border-earth-200 shadow-sm flex flex-col items-center justify-center text-center cursor-pointer hover:bg-earth-100 transition" onclick="openModal('modal-hotel')">
                    <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-earth-600 mb-2 shadow-sm"><i class="fa-solid fa-hotel text-lg"></i></div>
                    <span class="text-sm font-bold text-earth-800">é£¯åº—æ†‘è­‰</span>
                </div>
                <div class="bg-earth-50 p-4 rounded-2xl border border-earth-200 shadow-sm flex flex-col items-center justify-center text-center cursor-pointer hover:bg-earth-100 transition" onclick="openModal('modal-car')">
                    <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-earth-600 mb-2 shadow-sm"><i class="fa-solid fa-car-side text-lg"></i></div>
                    <span class="text-sm font-bold text-earth-800">ç§Ÿè»Šè³‡è¨Š</span>
                </div>
                <div class="bg-earth-50 p-4 rounded-2xl border border-earth-200 shadow-sm flex flex-col items-center justify-center text-center cursor-pointer hover:bg-earth-100 transition" onclick="openRulesModal()">
                    <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-earth-600 mb-2 shadow-sm"><i class="fa-solid fa-triangle-exclamation text-lg"></i></div>
                    <span class="text-sm font-bold text-earth-800">æ—…éŠè¦ç¯„</span>
                </div>
            </div>

            <!-- Emergency Info -->
            <div class="bg-red-50 p-4 rounded-2xl border border-red-100 shadow-sm !mt-4">
                <h4 class="text-sm font-bold text-red-800 mb-3"><i class="fa-solid fa-phone-volume mr-1"></i> ç·Šæ€¥è¯çµ¡è³‡è¨Š</h4>
                <div class="space-y-2">
                    <a href="tel:110" class="flex justify-between items-center bg-white p-3 rounded-xl shadow-sm text-earth-800 hover:bg-gray-50">
                        <span class="font-bold text-sm"><i class="fa-solid fa-building-shield text-blue-600 w-5"></i> è­¦å¯Ÿå±€</span>
                        <span class="font-black tracking-widest">110</span>
                    </a>
                    <a href="tel:119" class="flex justify-between items-center bg-white p-3 rounded-xl shadow-sm text-earth-800 hover:bg-gray-50">
                        <span class="font-bold text-sm"><i class="fa-solid fa-truck-medical text-red-600 w-5"></i> æ¶ˆé˜²/æ•‘è­·</span>
                        <span class="font-black tracking-widest">119</span>
                    </a>
                    <div class="bg-white p-3 rounded-xl shadow-sm text-earth-800">
                        <div class="font-bold text-sm mb-1"><i class="fa-solid fa-passport text-earth-600 w-5"></i> é§å¤§é˜ªè¾¦äº‹è™• (å²¡å±±è½„å€)</div>
                        <div class="text-xs text-earth-500">æ€¥é›£æ•‘åŠ©ï¼š+81-90-8794-4568</div>
                    </div>
                </div>
            </div>

            <!-- Packing List -->
            <div class="bg-white border border-earth-200 rounded-2xl shadow-sm overflow-hidden !mt-4">
                <div class="bg-earth-100 p-3 flex justify-between items-center">
                    <h4 class="font-bold text-earth-800 text-sm"><i class="fa-solid fa-suitcase-rolling mr-1"></i> è¡Œææ‰“åŒ…æ¸…å–®</h4>
                    <button onclick="openPackingModal()" class="text-xs bg-earth-800 text-white px-2 py-1 rounded shadow"><i class="fa-solid fa-plus"></i> æ–°å¢</button>
                </div>
                <div class="p-4 space-y-4" id="packing-lists-container">
                    <!-- JS Populated grouped by category -->
                </div>
            </div>

        </div>

    </main>

    <!-- Floating Action Button (Only for Itinerary & Accounting) -->
    <button id="main-fab" onclick="handleFabClick()" class="fab-btn absolute bottom-24 right-5 bg-terracotta-600 text-white w-14 h-14 rounded-full flex items-center justify-center text-xl shadow-lg hover:bg-terracotta-700 transition-transform z-20">
        <i class="fa-solid fa-plus"></i>
    </button>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 w-full max-w-md bg-white border-t border-earth-200 p-2 pb-6 z-30 flex justify-around rounded-t-2xl shadow-[0_-10px_15px_rgba(0,0,0,0.03)]">
        <button onclick="switchView('itinerary')" class="nav-item w-full py-2 flex flex-col items-center gap-1 text-terracotta-600 transition-colors" id="nav-itinerary">
            <i class="fa-solid fa-map-location-dot text-xl"></i><span class="text-[10px] font-bold">è¡Œç¨‹</span>
        </button>
        <button onclick="switchView('weather')" class="nav-item w-full py-2 flex flex-col items-center gap-1 text-earth-400 transition-colors" id="nav-weather">
            <i class="fa-solid fa-cloud-sun text-xl"></i><span class="text-[10px] font-bold">å¤©æ°£</span>
        </button>
        <button onclick="switchView('accounting')" class="nav-item w-full py-2 flex flex-col items-center gap-1 text-earth-400 transition-colors" id="nav-accounting">
            <i class="fa-solid fa-wallet text-xl"></i><span class="text-[10px] font-bold">åˆ†å¸³</span>
        </button>
        <button onclick="switchView('tools')" class="nav-item w-full py-2 flex flex-col items-center gap-1 text-earth-400 transition-colors" id="nav-tools">
            <i class="fa-solid fa-toolbox text-xl"></i><span class="text-[10px] font-bold">å·¥å…·</span>
        </button>
    </nav>

    <!-- ================= MODALS ================= -->

    <!-- Itinerary Edit Modal -->
    <div id="modal-itinerary" class="fixed inset-0 bg-black/60 hidden z-50 flex items-end sm:items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-md max-h-[90vh] overflow-y-auto rounded-t-3xl sm:rounded-3xl p-6 transform translate-y-full transition-transform duration-300 relative hide-scrollbar" id="modal-itinerary-content">
            <button onclick="closeModal('modal-itinerary')" class="absolute top-4 right-4 text-earth-400 hover:text-earth-800 bg-earth-100 rounded-full w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            <h3 class="text-xl font-black text-earth-900 mb-5">ç·¨è¼¯è¡Œç¨‹</h3>
            
            <form id="form-itinerary" class="space-y-4">
                <input type="hidden" id="edit-id">
                
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-earth-500 mb-1">æ™‚é–“</label>
                        <input type="time" id="input-time" class="w-full bg-earth-50 p-3 rounded-xl border border-earth-200 outline-none focus:border-sage-500" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-earth-500 mb-1">åˆ†é¡</label>
                        <select id="input-category" class="w-full bg-earth-50 p-3 rounded-xl border border-earth-200 outline-none text-sm focus:border-sage-500">
                            <option value="attraction">ğŸ“¸ æ™¯é»</option>
                            <option value="food">ğŸ½ï¸ ç¾é£Ÿ</option>
                            <option value="transport">ğŸš— äº¤é€š</option>
                            <option value="shopping">ğŸ›ï¸ è³¼ç‰©</option>
                            <option value="hotel">ğŸ¨ ä½å®¿</option>
                            <option value="activity">ğŸŸï¸ æ´»å‹•</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-earth-500 mb-1">è¡Œç¨‹åç¨±</label>
                    <input type="text" id="input-title" placeholder="ä¾‹ï¼šå²¡å±±åŸ" class="w-full bg-earth-50 p-3 rounded-xl border border-earth-200 outline-none font-bold text-earth-900 focus:border-sage-500" required>
                </div>

                <!-- Advanced Info Box -->
                <div class="bg-earth-50 p-4 rounded-xl border border-earth-200 space-y-3">
                    <h4 class="text-xs font-bold text-earth-700 mb-2 border-b border-earth-200 pb-1">è©³ç´°è³‡è¨Š (é¸å¡«)</h4>
                    
                    <div>
                        <label class="block text-[10px] font-bold text-earth-500 mb-1"><i class="fa-solid fa-location-dot"></i> åœ°é» / å°èˆªé—œéµå­—</label>
                        <input type="text" id="input-location" placeholder="è¼¸å…¥ Google Map é—œéµå­—" class="w-full bg-white p-2 text-sm rounded border border-earth-200 outline-none">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-[10px] font-bold text-earth-500 mb-1"><i class="fa-regular fa-clock"></i> å»ºè­°åœç•™</label>
                            <input type="text" id="input-duration" placeholder="ä¾‹: 1.5å°æ™‚" class="w-full bg-white p-2 text-sm rounded border border-earth-200 outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-earth-500 mb-1"><i class="fa-solid fa-car"></i> äº¤é€šæ™‚é–“</label>
                            <input type="text" id="input-transport" placeholder="ä¾‹: è»Šç¨‹30åˆ†" class="w-full bg-white p-2 text-sm rounded border border-earth-200 outline-none">
                        </div>
                    </div>

                    <div>
                        <label class="block text-[10px] font-bold text-terracotta-600 mb-1"><i class="fa-solid fa-lightbulb"></i> å¿…åƒ/å¿…è²·/Tips</label>
                        <input type="text" id="input-tips" placeholder="ä¾‹: å¿…åƒæ°´èœœæ¡ƒè–ä»£" class="w-full bg-white p-2 text-sm rounded border border-terracotta-500 outline-none">
                    </div>

                    <div>
                        <label class="block text-[10px] font-bold text-blue-600 mb-1"><i class="fa-solid fa-square-parking"></i> åœè»Š/åŠ æ²¹è³‡è¨Š</label>
                        <input type="text" id="input-parking" placeholder="ä¾‹: é™„è¿‘æœ‰ Times åœè»Šå ´" class="w-full bg-white p-2 text-sm rounded border border-blue-200 outline-none">
                    </div>

                    <div>
                        <label class="block text-[10px] font-bold text-earth-500 mb-1">å‚™è¨»èªªæ˜</label>
                        <textarea id="input-notes" placeholder="å…¶ä»–å‚™è¨»äº‹é …..." class="w-full bg-white p-2 text-sm rounded border border-earth-200 outline-none h-16 resize-none"></textarea>
                    </div>
                </div>

                <div class="pt-2">
                    <button type="submit" class="w-full bg-terracotta-600 text-white py-3 rounded-xl font-black shadow-md hover:bg-terracotta-700">å„²å­˜è¡Œç¨‹</button>
                    <button type="button" id="btn-delete-itinerary" class="hidden w-full bg-red-50 text-red-600 border border-red-200 py-3 rounded-xl font-bold mt-3">åˆªé™¤æ­¤è¡Œç¨‹</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Expense Modal -->
    <div id="modal-expense" class="fixed inset-0 bg-black/60 hidden z-50 flex items-end sm:items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 transform translate-y-full transition-transform duration-300 relative" id="modal-expense-content">
            <button onclick="closeModal('modal-expense')" class="absolute top-4 right-4 text-earth-400 hover:text-earth-800 bg-earth-100 rounded-full w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            <h3 class="text-xl font-black text-earth-900 mb-5">æ–°å¢æ”¯å‡º</h3>
            <form id="form-expense" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-earth-500 mb-1">é …ç›®</label>
                    <input type="text" id="exp-title" placeholder="ä¾‹ï¼šåˆé¤ - ç‡’è‚‰" class="w-full bg-earth-50 p-3 rounded-xl border border-earth-200 outline-none focus:border-sage-500" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-earth-500 mb-1">ä»£å¢Šä»˜æ¬¾äºº</label>
                    <select id="exp-payer" class="w-full bg-earth-50 p-3 rounded-xl border border-earth-200 outline-none text-sm"></select>
                </div>
                <div class="flex gap-3">
                    <div class="w-1/3">
                        <label class="block text-xs font-bold text-earth-500 mb-1">å¹£åˆ¥</label>
                        <select id="exp-currency" class="w-full bg-earth-50 p-3 rounded-xl border border-earth-200 outline-none text-sm font-bold text-earth-800">
                            <option value="JPY">JPY Â¥</option>
                            <option value="TWD">TWD NT$</option>
                        </select>
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-earth-500 mb-1">é‡‘é¡</label>
                        <input type="number" id="exp-amount" placeholder="0" class="w-full bg-earth-50 p-3 rounded-xl border border-earth-200 outline-none" required>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-earth-500 mb-1">ç™¼ç”Ÿæ—¥æœŸ</label>
                    <select id="exp-date" class="w-full bg-earth-50 p-3 rounded-xl border border-earth-200 outline-none text-sm"></select>
                </div>
                <div class="bg-earth-50 p-3 rounded-xl border border-earth-200">
                    <div class="flex justify-between items-end mb-2">
                        <label class="block text-xs font-bold text-earth-500">é¸æ“‡åˆ†å¸³æˆå“¡</label>
                        <button type="button" onclick="toggleAllMembers()" id="btn-toggle-members" class="text-[10px] text-sage-600 font-bold border border-sage-600 px-2 py-0.5 rounded bg-white">å–æ¶ˆå…¨é¸</button>
                    </div>
                    <div class="grid grid-cols-3 gap-2" id="split-members-container"></div>
                </div>
                <button type="submit" class="w-full bg-sage-600 text-white py-3 rounded-xl font-black shadow-md hover:bg-sage-700 mt-2">æ–°å¢ç´€éŒ„</button>
            </form>
        </div>
    </div>

    <!-- Packing Add Modal -->
    <div id="modal-packing" class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-white w-5/6 max-w-sm rounded-3xl p-6 transform scale-95 transition-transform duration-300 relative" id="modal-packing-content">
            <button onclick="closeModal('modal-packing')" class="absolute top-4 right-4 text-earth-400"><i class="fa-solid fa-xmark text-xl"></i></button>
            <h3 class="text-lg font-black text-earth-900 mb-4">æ–°å¢ç‰©å“</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-earth-500 mb-1">ç‰©å“åˆ†é¡</label>
                    <select id="pack-category" class="w-full bg-earth-50 p-3 rounded-xl border border-earth-200 text-sm outline-none">
                        <option value="carryOn">ğŸ’ éš¨èº«èƒŒåŒ…</option>
                        <option value="cabin">ğŸ§³ æ‰‹æè¡Œæ (æ©Ÿè‰™)</option>
                        <option value="checked">ğŸ“¦ æ‰˜é‹è¡Œæ</option>
                        <option value="shopping">ğŸ›’ è³¼ç‰©æ¸…å–® (æ—¥æœ¬è²·)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-earth-500 mb-1">ç‰©å“åç¨±</label>
                    <input type="text" id="pack-name" placeholder="ä¾‹ï¼šè­·ç…§ / è…¸èƒƒè—¥" class="w-full bg-earth-50 p-3 rounded-xl border border-earth-200 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-earth-500 mb-1">æ•¸é‡</label>
                    <input type="number" id="pack-qty" value="1" min="1" class="w-full bg-earth-50 p-3 rounded-xl border border-earth-200 outline-none">
                </div>
                <button onclick="addPackingItem()" class="w-full bg-earth-800 text-white py-3 rounded-xl font-bold shadow-md">åŠ å…¥æ¸…å–®</button>
            </div>
        </div>
    </div>

    <!-- Rules Modal -->
    <div id="modal-rules" class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-white w-5/6 max-w-md max-h-[80vh] overflow-y-auto rounded-3xl p-6 transform scale-95 transition-transform duration-300 relative hide-scrollbar" id="modal-rules-content">
            <button onclick="closeModal('modal-rules')" class="absolute top-4 right-4 text-earth-400 bg-earth-100 rounded-full w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            <h3 class="text-xl font-black text-earth-900 mb-4 border-b-2 border-terracotta-500 pb-2 inline-block">æ—¥æœ¬æ—…éŠè¦ç¯„æé†’</h3>
            <div class="space-y-4 text-sm text-earth-800 mt-4 leading-relaxed">
                <div class="bg-blue-50 p-3 rounded-xl border border-blue-100">
                    <strong class="text-blue-800"><i class="fa-solid fa-car-rear"></i> è‡ªé§•é ˆçŸ¥ï¼š</strong>
                    <ul class="list-disc pl-5 mt-1 space-y-1 text-blue-900/80">
                        <li>æ—¥æœ¬ç‚ºå³é§•ï¼Œé å·¦è¡Œé§›ã€‚</li>
                        <li><strong>çµ•å°ç¦æ­¢é…’é§•</strong>ï¼Œé€£å‰¯é§•éƒ½æœƒå—ç½°ã€‚</li>
                        <li>è¦‹åˆ°ã€Œæ­¢ã¾ã‚Œã€(å€’ä¸‰è§’å½¢ç´…åº•ç™½å­—)ï¼Œå¿…é ˆ<strong>å®Œå…¨åœæ­¢</strong>3ç§’å†é–‹ã€‚</li>
                        <li>è»Šä¸Šå°èˆªé€šå¸¸å¯è¼¸å…¥å•†å®¶é›»è©±è™Ÿç¢¼è¨­å®šç›®çš„åœ°ã€‚</li>
                    </ul>
                </div>
                <div class="bg-earth-50 p-3 rounded-xl border border-earth-200">
                    <strong class="text-earth-800"><i class="fa-solid fa-train-subway"></i> ä¹˜è»Šèˆ‡å…¬å…±ç¦®å„€ï¼š</strong>
                    <ul class="list-disc pl-5 mt-1 space-y-1 text-earth-600">
                        <li>é›»è»Šã€å…¬è»Šå…§è«‹å°‡æ‰‹æ©Ÿè½‰éœéŸ³ï¼Œä¸”<strong>ç¦æ­¢è¬›é›»è©±</strong>ã€‚</li>
                        <li>æ‰‹æ‰¶æ¢¯é€šå¸¸é å·¦ç«™ç«‹ï¼ˆé—œè¥¿åœ°å€å¦‚å¤§é˜ªé å³ï¼Œä½†å²¡å±±ä»¥é å·¦ç‚ºä¸»ï¼‰ã€‚</li>
                        <li>è¡—ä¸Šè«‹å‹¿é‚Šèµ°é‚Šåƒï¼ˆç¥­å…¸æ”¤ä½å‘¨é‚Šé™¤å¤–ï¼‰ï¼Œä¹Ÿå‹¿äº‚ä¸Ÿåƒåœ¾ï¼Œåƒåœ¾æ¡¶é€šå¸¸åœ¨è¶…å•†æˆ–è²©è³£æ©Ÿæ—ã€‚</li>
                    </ul>
                </div>
                <div class="bg-sage-50 p-3 rounded-xl border border-sage-200">
                    <strong class="text-sage-800"><i class="fa-solid fa-shop"></i> è³¼ç‰©èˆ‡å…ç¨…ï¼š</strong>
                    <ul class="list-disc pl-5 mt-1 space-y-1 text-sage-900/80">
                        <li>å…ç¨…(Tax Free)é–€æª»é€šå¸¸ç‚ºå–®åº—æ»¿ 5,000 æ—¥åœ“(æœªç¨…)ã€‚</li>
                        <li>çµå¸³æ™‚è«‹ä¸»å‹•å‡ºç¤ºè­·ç…§æ­£æœ¬ï¼ˆç…§ç‰‡ç„¡æ•ˆï¼‰ã€‚</li>
                        <li>å…ç¨…åŒ…è£ï¼ˆæ¶ˆè€—å“ï¼‰åœ¨æ—¥æœ¬å¢ƒå…§ä¸å¯æ‹†å°ã€‚</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Flight Modal -->
    <div id="modal-flight" class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-white w-5/6 max-w-md rounded-3xl p-6 transform scale-95 transition-transform duration-300 relative" id="modal-flight-content">
            <button onclick="closeModal('modal-flight')" class="absolute top-4 right-4 text-earth-400 bg-earth-100 rounded-full w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            <h3 class="text-xl font-black text-earth-900 mb-4 border-b-2 border-sage-500 pb-2 inline-block"><i class="fa-solid fa-plane-departure mr-2"></i>èˆªç­è³‡è¨Š</h3>
            <div class="space-y-4 text-sm text-earth-800 mt-4">
                <div class="bg-earth-50 p-4 rounded-xl border border-earth-200">
                    <p class="font-bold mb-2 text-earth-900">8/20(å››)å»ç¨‹ï¼šIT214</p>
                    <p class="text-earth-600">æ¡ƒåœ’æ©Ÿå ´ 11:30 <i class="fa-solid fa-arrow-right mx-2 text-earth-400"></i> å²¡å±±æ©Ÿå ´ 15:05</p>
                </div>
                <div class="bg-earth-50 p-4 rounded-xl border border-earth-200">
                    <p class="font-bold mb-2 text-earth-900">8/23(æ—¥)å›ç¨‹ï¼šIT215 æ¯›&å©·</p>
                    <p class="text-earth-600">å²¡å±±æ©Ÿå ´ 17:55 <i class="fa-solid fa-arrow-right mx-2 text-earth-400"></i> æ¡ƒåœ’æ©Ÿå ´ 19:55</p>
               </div>
                <div class="bg-earth-50 p-4 rounded-xl border border-earth-200">
                    <p class="font-bold mb-2 text-earth-900">8/26(ä¸‰)å›ç¨‹ï¼šIT215 è‘³&è˜‹&æ„·</p>
                    <p class="text-earth-600">å²¡å±±æ©Ÿå ´ 15:55 <i class="fa-solid fa-arrow-right mx-2 text-earth-400"></i> æ¡ƒåœ’æ©Ÿå ´ 19:55</p>
                </div>
                <!-- æ›¿æ› href å…§çš„é€£çµå³å¯æ”¾ä¸Š PDF -->
                <a href="#" target="_blank" class="block w-full text-center bg-sage-600 text-white py-3 rounded-xl font-bold shadow-md hover:bg-sage-700 transition mt-4">
                    <i class="fa-solid fa-file-pdf mr-1"></i> æª¢è¦–é›»å­æ©Ÿç¥¨ (PDF)
                </a>
            </div>
        </div>
    </div>

    <!-- Hotel Modal -->
    <div id="modal-hotel" class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-white w-5/6 max-w-md rounded-3xl p-6 transform scale-95 transition-transform duration-300 relative" id="modal-hotel-content">
            <button onclick="closeModal('modal-hotel')" class="absolute top-4 right-4 text-earth-400 bg-earth-100 rounded-full w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            <h3 class="text-xl font-black text-earth-900 mb-4 border-b-2 border-earth-500 pb-2 inline-block"><i class="fa-solid fa-hotel mr-2"></i>ä½å®¿æ†‘è­‰</h3>
            <div class="space-y-4 text-sm text-earth-800 mt-4">
                <div class="bg-earth-50 p-4 rounded-xl border border-earth-200">
                    <p class="font-bold mb-2 text-earth-900 text-base">åˆ©å¤«é¦¬å…‹æ–¯å²¡å±±å€‰æ•·ç«™å‰é£¯åº—</p>
                    <p class="text-earth-600 text-xs mb-3">Hotel Livemax Okayama Kurashiki Station</p>
                    <p class="text-earth-600 mb-1"><i class="fa-solid fa-calendar-day w-5 text-center"></i> å…¥ä½ï¼š8/20 - 8/23 (3æ™š)</p>
                    <p class="text-earth-600"><i class="fa-solid fa-location-dot w-5 text-center"></i> åœ°å€ï¼šå€‰æ•·å¸‚é˜¿çŸ¥2-1-20</p>
                </div>
                <!-- æ›¿æ› href å…§çš„é€£çµå³å¯æ”¾ä¸Š PDF -->
                <a href="https://drive.google.com/file/d/16BwW2QWTMV-j4YQKldDmv0HrgkF6mXWJ/view?usp=drive_link" target="_blank" class="block w-full text-center bg-earth-800 text-white py-3 rounded-xl font-bold shadow-md hover:bg-earth-900 transition mt-4">
                    <i class="fa-solid fa-file-pdf mr-1"></i> æª¢è¦–è¨‚æˆ¿ç¢ºèªä¿¡ (PDF)
                </a>
            </div>
        </div>
    </div>

    <!-- Car Rental Modal -->
    <div id="modal-car" class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-white w-5/6 max-w-md rounded-3xl p-6 transform scale-95 transition-transform duration-300 relative" id="modal-car-content">
            <button onclick="closeModal('modal-car')" class="absolute top-4 right-4 text-earth-400 bg-earth-100 rounded-full w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            <h3 class="text-xl font-black text-earth-900 mb-4 border-b-2 border-blue-500 pb-2 inline-block"><i class="fa-solid fa-car-side mr-2"></i>ç§Ÿè»Šè³‡è¨Š</h3>
            <div class="space-y-4 text-sm text-earth-800 mt-4">
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                    <p class="font-bold mb-2 text-blue-900">å²¡å±±æ©Ÿå ´å–é‚„ (å…±2å°è»Š)</p>
                    <ul class="list-disc pl-5 mt-2 space-y-1 text-blue-800">
                        <li>å–è»Šï¼š8/20 15:30</li>
                        <li>é‚„è»Šï¼š8/23 15:45</li>
                    </ul>
                    <div class="mt-4 pt-3 border-t border-blue-200">
                        <p class="font-bold text-red-600 text-xs"><i class="fa-solid fa-circle-exclamation mr-1"></i> å¿…å‚™æ–‡ä»¶ï¼š</p>
                        <p class="text-blue-800 text-xs mt-1 font-bold">å°ç£é§•ç…§æ­£æœ¬ã€æ—¥æ–‡è­¯æœ¬ã€è­·ç…§</p>
                    </div>
                </div>
                <!-- æ›¿æ› href å…§çš„é€£çµå³å¯æ”¾ä¸Š PDF -->
                <a href="#" target="_blank" class="block w-full text-center bg-blue-600 text-white py-3 rounded-xl font-bold shadow-md hover:bg-blue-700 transition mt-4">
                    <i class="fa-solid fa-file-pdf mr-1"></i> æª¢è¦–ç§Ÿè»Šæ†‘è­‰ (PDF)
                </a>
            </div>
        </div>
    </div>

    <!-- Settlement Modal -->
    <div id="modal-settlement" class="fixed inset-0 bg-black/60 hidden z-50 flex items-end sm:items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-md h-[80vh] sm:h-auto sm:max-h-[85vh] sm:rounded-3xl rounded-t-3xl p-6 transform translate-y-full transition-transform duration-300 flex flex-col" id="modal-settlement-content">
            <div class="flex justify-between items-center mb-6 flex-shrink-0">
                <h3 class="text-xl font-black text-earth-900">çµç®—æ¸…å–®</h3>
                <button onclick="closeModal('modal-settlement')" class="bg-earth-100 rounded-full w-8 h-8"><i class="fa-solid fa-xmark text-earth-500"></i></button>
            </div>
            <div class="bg-earth-50 p-4 rounded-xl mb-4 flex-shrink-0 border border-earth-200">
                <label class="block text-xs font-bold text-earth-600 mb-2">å…¨åŸŸåŒ¯ç‡è¨­å®š (JPY â†’ TWD)</label>
                <div class="flex items-center gap-2">
                    <input type="number" id="settle-rate" step="0.001" class="flex-1 p-3 rounded-xl border border-earth-300 text-lg font-bold outline-none text-center">
                    <button onclick="saveRateAndCalc()" class="bg-sage-600 text-white px-4 py-3 rounded-xl font-bold shadow hover:bg-sage-700">å„²å­˜è¨ˆç®—</button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto pr-1 hide-scrollbar space-y-3" id="settlement-results"></div>
        </div>
    </div>

    <!-- Members Modal -->
    <div id="modal-members" class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-white w-3/4 max-w-sm rounded-3xl p-6 transform scale-95 transition-transform duration-300" id="modal-members-content">
            <h3 class="text-lg font-black text-earth-900 mb-4 border-b-2 border-sage-500 pb-1 inline-block">æˆå“¡ç®¡ç†</h3>
            <div id="members-list" class="space-y-2 mb-4 max-h-[40vh] overflow-y-auto hide-scrollbar"></div>
            <div class="flex gap-2">
                <input type="text" id="new-member-name" placeholder="è¼¸å…¥åå­—" class="flex-1 bg-earth-50 p-3 rounded-xl border border-earth-200 text-sm outline-none">
                <button onclick="addMember()" class="bg-earth-800 text-white px-4 rounded-xl font-bold"><i class="fa-solid fa-plus"></i></button>
            </div>
            <div class="mt-6 text-center">
                <button onclick="closeModal('modal-members')" class="w-full bg-earth-200 text-earth-800 font-bold py-3 rounded-xl">å®Œæˆ</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // âš ï¸ é‡è¦ï¼šè«‹åœ¨æ­¤è™•å¡«å…¥æ‚¨çš„ Firebase è¨­å®š
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyCEfhniotkKkTVllevVcULi1p7HXn79GGg",
            authDomain: "miyazakitrip-acec0.firebaseapp.com",
            projectId: "miyazakitrip-acec0",
            storageBucket: "miyazakitrip-acec0.firebasestorage.app",
            messagingSenderId: "681143086518",
            appId: "1:681143086518:web:a471a2893bba96cb3d6517"
        };
        // ==========================================

        let db;
        let unsubscribe;

        // --- Data & State ---
        // å²¡å±±è¡Œç¨‹æ—¥æœŸ
        const tripDates = [
            { date: '2026-08-20', label: '8/20', day: 'å››' },
            { date: '2026-08-21', label: '8/21', day: 'äº”' },
            { date: '2026-08-22', label: '8/22', day: 'å…­' },
            { date: '2026-08-23', label: '8/23', day: 'æ—¥' },
        ];

        const weatherMockData = {
            '2026-08-20': { temp: '33Â°C', feels: '36Â°C', icon: 'fa-sun', color: 'text-orange-500', cloth: 'çŸ­è¢–çŸ­è¤² + é®é™½å¸½', desc: 'æ™´æœ—ç‚ç†±ï¼Œæ³¨æ„é˜²æ›¬' },
            '2026-08-21': { temp: '34Â°C', feels: '37Â°C', icon: 'fa-sun', color: 'text-red-500', cloth: 'æ¶¼æ„Ÿè¡£ + å¢¨é¡é™½å‚˜', desc: 'é…·ç†±ï¼Œå¤šè£œå……æ°´åˆ†' },
            '2026-08-22': { temp: '32Â°C', feels: '35Â°C', icon: 'fa-cloud-sun', color: 'text-orange-400', cloth: 'é€æ°£æ£‰éº» + é˜²æ›¬å¤–å¥—', desc: 'æ™´æ™‚å¤šé›²ï¼Œæµ·é‚Šé¢¨å¤§' },
            '2026-08-23': { temp: '31Â°C', feels: '34Â°C', icon: 'fa-cloud', color: 'text-gray-400', cloth: 'è¼•è–„é•·è¢– + èˆ’é©ä¾¿é‹', desc: 'å¤šé›²èˆ’é©ï¼Œé©åˆå¸‚å€æ•£æ­¥' }
        };

        const defaultItinerary = [
            // Day 1
            { id: 101, date: '2026-08-20', time: '09:30', category: 'transport', title: 'æŠµé”æ¡ƒåœ’æ©Ÿå ´', location: 'Taoyuan Airport', duration: '', transportTime: '', tips: '', parking: '', notes: '11:30 èµ·é£› (IT214)' },
            { id: 102, date: '2026-08-20', time: '15:05', category: 'transport', title: 'æŠµé”å²¡å±±æ©Ÿå ´ & ç§Ÿè»Š', location: 'Okayama Airport', duration: 'ç´„1å°æ™‚è¾¦ç†', transportTime: 'é£›è¡Œç´„2.5å°æ™‚', tips: '11äººéœ€åˆ†2å°è»Šï¼Œå‚™é½Šæ—¥æ–‡è­¯æœ¬èˆ‡å°ç£é§•ç…§', parking: 'æ©Ÿå ´ç§Ÿè»Šå°ˆç”¨å€', notes: 'é è¨ˆ 16:15 å‡ºç™¼' },
            { id: 103, date: '2026-08-20', time: '17:00', category: 'food', title: 'å²¡å±±å¸‚å€æ™šé¤', location: 'å²¡å±±ç«™å‰', duration: '1.5å°æ™‚', transportTime: 'è»Šç¨‹ç´„30åˆ†', tips: 'æ¨è–¦ç‡’è‚‰æˆ–å£½å¸', parking: 'å‘¨é‚Šå¤šæ”¶è²»åœè»Šå ´', notes: '' },
            { id: 104, date: '2026-08-20', time: '19:15', category: 'hotel', title: 'é£¯åº— Check-in', location: 'åˆ©å¤«é¦¬å…‹æ–¯å²¡å±±å€‰æ•·ç«™å‰é£¯åº—', duration: '45åˆ†', transportTime: 'è»Šç¨‹ç´„40-45åˆ†', tips: 'é€£å®¿ä¸‰å¤©ä¸ç”¨æ”¶è¡Œæ', parking: 'é£¯åº—åœè»Šæˆ–å‘¨é‚Šç‰¹ç´„', notes: '' },
            { id: 105, date: '2026-08-20', time: '20:00', category: 'shopping', title: 'é£¯åº—å‘¨é‚Šæ¡è³¼', location: 'Ario å€‰æ•· / YOURS è¶…å¸‚', duration: 'è‡ªç”±æ™‚é–“', transportTime: 'æ­¥è¡Œ', tips: 'è²·æ°´æœã€é›¶é£Ÿå’Œéš”å¤©æ—©é¤', parking: '', notes: 'Arioç‡Ÿæ¥­è‡³21:00ï¼ŒYOURSé–‹è¼ƒæ™š' },
            // Day 2
            { id: 201, date: '2026-08-21', time: '10:15', category: 'attraction', title: 'å²¡å±±å¾Œæ¨‚åœ’ & å²¡å±±åŸ', location: 'Okayama Korakuen', duration: 'ç´„2.5å°æ™‚', transportTime: 'è»Šç¨‹ç´„45åˆ†', tips: 'æ—¥æœ¬ä¸‰å¤§ååœ’ï¼Œå¿…æ‹çƒåŸ', parking: 'å¾Œæ¨‚åœ’å‰åœè»Šå ´', notes: 'å…©è™•ç›¸é€£ï¼Œæ­¥è¡Œå³å¯' },
            { id: 202, date: '2026-08-21', time: '12:30', category: 'food', title: 'åˆé¤', location: 'å²¡å±±åŸå‘¨é‚Š', duration: '1å°æ™‚', transportTime: 'æ­¥è¡Œ', tips: '', parking: '', notes: '' },
            { id: 203, date: '2026-08-21', time: '14:00', category: 'shopping', title: 'AEON Mall å²¡å±±', location: 'AEON Mall Okayama', duration: '3.5å°æ™‚', transportTime: 'è»Šç¨‹15åˆ†', tips: 'è¥¿æ—¥æœ¬æœ€å¤§ï¼Œå“ç‰Œæ¥µå…¨ï¼å¹å†·æ°£é¿æš‘', parking: 'AEONç«‹é«”åœè»Šå ´', notes: '' },
            { id: 204, date: '2026-08-21', time: '19:00', category: 'food', title: 'æ™šé¤', location: 'å€‰æ•·è»Šç«™é™„è¿‘', duration: '1.5å°æ™‚', transportTime: 'è»Šç¨‹ç´„45åˆ†', tips: 'å¯é¸å±…é…’å±‹é«”é©—', parking: '', notes: '' },
            // Day 3
            { id: 301, date: '2026-08-22', time: '09:30', category: 'attraction', title: 'å‰å‚™æ´¥ç¥ç¤¾', location: 'Kibitsu Shrine', duration: 'ç´„1å°æ™‚', transportTime: 'è»Šç¨‹ç´„30åˆ†', tips: 'æ¡ƒå¤ªéƒå‚³èªªç™¼æºåœ°ï¼Œå¿…æ‹ 360å…¬å°ºç¥è©±é•·å»Š', parking: 'ç¥ç¤¾å…è²»åœè»Šå ´', notes: '' },
            { id: 302, date: '2026-08-22', time: '12:00', category: 'food', title: 'åˆé¤ï¼šå…’å³¶/é·²ç¾½å±±', location: 'Washuzan', duration: '1.5å°æ™‚', transportTime: 'è»Šç¨‹ç´„45åˆ†', tips: 'å¿…åƒï¼šç€¨æˆ¶å…§æµ·æ–°é®®ç« é­šæ–™ç†', parking: '', notes: '' },
            { id: 303, date: '2026-08-22', time: '13:30', category: 'activity', title: 'é·²ç¾½å±±å±•æœ›å° / å·´è¥¿éŠæ¨‚åœ’', location: 'Washuzan Observatory', duration: '2å°æ™‚', transportTime: 'è»Šç¨‹5åˆ†', tips: 'ç„¡æ•µæµ·æ™¯ï¼å°å­©æœ‰é«”åŠ›å¯å»éŠæ¨‚åœ’é¨ã€Œç©ºä¸­è…³è¸è»Šã€', parking: 'å±•æœ›å°åœè»Šå ´', notes: '' },
            { id: 304, date: '2026-08-22', time: '18:00', category: 'food', title: 'æ™šé¤ï¼šå€‰æ•·å¸‚å€', location: 'Kurashiki', duration: '', transportTime: 'è»Šç¨‹ç´„45åˆ†', tips: '', parking: '', notes: 'è‡ªç”±æ¡è³¼æˆ–å±…é…’å±‹' },
            // Day 4
            { id: 401, date: '2026-08-23', time: '09:00', category: 'hotel', title: 'é€€æˆ¿å‰å¾€ç¾è§€åœ°å€', location: 'å€‰æ•·ç¾è§€åœ°å€', duration: '', transportTime: 'è»Šç¨‹10åˆ†/æ­¥è¡Œ', tips: 'è¡Œæä¸Šè»Š', parking: 'ç¾è§€åœ°å€å¤–åœåœè»Šå ´', notes: '' },
            { id: 402, date: '2026-08-23', time: '09:30', category: 'activity', title: 'æ¶è³¼å€‰æ•·å·ä¹˜èˆ¹ç¥¨', location: 'å€‰æ•·é¤¨è§€å…‰æ¡ˆå…§æ‰€', duration: 'æ’éšŠ', transportTime: '', tips: 'âš ï¸ä¸èƒ½é ç´„ï¼11äººéœ€åˆ†2è‰˜(ä¸Šé™6äºº)ï¼Œ09:30é–‹é–€å³è¡', parking: '', notes: 'ç¥¨åƒ¹500æ—¥åœ“/äºº' },
            { id: 403, date: '2026-08-23', time: '10:00', category: 'attraction', title: 'å€‰æ•·ç¾è§€åœ°å€æ·±åº¦éŠ', location: 'Kurashiki Bikan Historical Quarter', duration: '2.5å°æ™‚', transportTime: '', tips: 'ä¹˜èˆ¹(20åˆ†)ã€é€›å¸¸æ˜¥è—¤å»£å ´ã€å¿…åƒæ°´æœè–ä»£', parking: '', notes: '' },
            { id: 404, date: '2026-08-23', time: '12:30', category: 'food', title: 'åˆé¤', location: 'ç¾è§€åœ°å€', duration: '1.5å°æ™‚', transportTime: '', tips: '', parking: '', notes: '' },
            { id: 405, date: '2026-08-23', time: '14:40', category: 'attraction', title: 'æ©Ÿå ´å‚™æ¡ˆ (ç¦ç”°å…¬åœ’ æˆ– æ©Ÿå ´è§€æ™¯å°)', location: '', duration: 'ç´„1å°æ™‚', transportTime: 'è»Šç¨‹ç´„40åˆ†', tips: 'A:å…¬åœ’å¤§å‹æºœæ»‘æ¢¯æ”¾é›» B:æ©Ÿå ´å¹å†·æ°£è²·ä¼´æ‰‹ç¦®', parking: '', notes: '' },
            { id: 406, date: '2026-08-23', time: '15:45', category: 'transport', title: 'æ©Ÿå ´é‚„è»Š', location: 'Okayama Airport', duration: '', transportTime: '', tips: '', parking: '', notes: '17:55 ç­æ©Ÿèµ·é£› (IT215)' },
        ];

        const defaultMembers = ['åª½åª½', 'å¤§å“¥', 'å°æ¯›', 'ç¿”å“¥', 'ç­±è‘³', 'è€€å“¥', 'ç­±å©·', 'å¯§å¯§', 'å¿—æ„·']; 
        
        const defaultPacking = [
            { id: 1, cat: 'carryOn', name: 'è­·ç…§ & å‚™ç”¨å½±æœ¬', qty: 1, checked: false },
            { id: 2, cat: 'carryOn', name: 'æ—¥å¹£ç¾é‡‘ & ä¿¡ç”¨å¡', qty: 1, checked: false },
            { id: 3, cat: 'carryOn', name: 'å°ç£é§•ç…§æ­£æœ¬ & æ—¥æ–‡è­¯æœ¬', qty: 1, checked: false },
            { id: 4, cat: 'carryOn', name: 'æ‰‹æ©Ÿ & ç¶²å¡/eSIM', qty: 1, checked: false },
            { id: 5, cat: 'carryOn', name: 'è¡Œå‹•é›»æº (ä¸å¯æ‰˜é‹)', qty: 1, checked: false },
            { id: 6, cat: 'carryOn', name: 'é¢ç´™ & æ¿•ç´™å·¾', qty: 2, checked: false },
            { id: 7, cat: 'carryOn', name: 'é›¨å‚˜/é®é™½å¸½', qty: 1, checked: false },
            { id: 8, cat: 'cabin', name: 'å¹³æ¿/ç­†é›»', qty: 1, checked: false },
            { id: 9, cat: 'cabin', name: 'è²´é‡é£¾å“/æ‰‹éŒ¶', qty: 1, checked: false },
            { id: 10, cat: 'checked', name: 'æ›æ´—è¡£ç‰© (4å¤©3å¤œ+å‚™ç”¨)', qty: 5, checked: false },
            { id: 11, cat: 'checked', name: 'ç¡è¡£ & è²¼èº«è¡£ç‰©', qty: 4, checked: false },
            { id: 12, cat: 'checked', name: 'è¥ªå­', qty: 4, checked: false },
            { id: 13, cat: 'checked', name: 'ç›¥æ´—åŒ… (ç‰™åˆ·/ä¿é¤Šå“/åˆ®é¬åˆ€)', qty: 1, checked: false },
            { id: 14, cat: 'checked', name: 'å¸¸å‚™è—¥ (è…¸èƒƒ/æ„Ÿå†’/OKç¹ƒ)', qty: 1, checked: false },
            { id: 15, cat: 'checked', name: 'è¬ç”¨è½‰æ¥é ­ & å……é›»ç·š', qty: 2, checked: false },
            { id: 16, cat: 'checked', name: 'ç’°ä¿è¢‹/å¡‘è† è¢‹ (è£é«’è¡£æœç”¨)', qty: 3, checked: false },
            { id: 17, cat: 'shopping', name: 'åˆåŠ›ä»–å‘½ EX Plus', qty: 2, checked: false },
            { id: 18, cat: 'shopping', name: 'EVE æ­¢ç—›è—¥', qty: 2, checked: false },
            { id: 19, cat: 'shopping', name: 'ç‰¹è‰²ä¼´æ‰‹ç¦®/é›¶é£Ÿ', qty: 5, checked: false },
        ];

        // App State
        let state = {
            currentDate: tripDates[0].date,
            currentView: 'itinerary', 
            itinerary: [],
            expenses: [],
            members: [],
            packing: [],
            exchangeRate: 0.22
        };

        // UI Mapping
        const catConfig = {
            'attraction': { icon: 'fa-camera', color: 'text-terracotta-600', bg: 'bg-terracotta-100', label: 'æ™¯é»' },
            'food': { icon: 'fa-utensils', color: 'text-orange-600', bg: 'bg-orange-100', label: 'ç¾é£Ÿ' },
            'transport': { icon: 'fa-car-side', color: 'text-blue-600', bg: 'bg-blue-100', label: 'äº¤é€š' },
            'shopping': { icon: 'fa-bag-shopping', color: 'text-purple-600', bg: 'bg-purple-100', label: 'è³¼ç‰©' },
            'hotel': { icon: 'fa-hotel', color: 'text-indigo-600', bg: 'bg-indigo-100', label: 'ä½å®¿' },
            'activity': { icon: 'fa-ticket', color: 'text-pink-600', bg: 'bg-pink-100', label: 'æ´»å‹•' }
        };
        const packCatNames = { 'carryOn': 'ğŸ’ éš¨èº«èƒŒåŒ…', 'cabin': 'ğŸ§³ æ‰‹æè¡Œæ(æ©Ÿè‰™)', 'checked': 'ğŸ“¦ æ‰˜é‹è¡Œæ', 'shopping': 'ğŸ›’ è³¼ç‰©æ¸…å–®' };

        // --- Core Loading & Data Functions ---
        
        // éš±è—è¼‰å…¥ç•«é¢çš„å…±ç”¨å‡½å¼
        function hideLoading() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay && overlay.style.display !== 'none') {
                overlay.style.opacity = '0';
                setTimeout(() => overlay.style.display = 'none', 500);
            }
        }

        // å®‰å…¨è®€å– LocalStorage (é¿å…åœ¨ iframe è¢«é˜»æ“‹æ™‚ç•¶æ©Ÿ)
        function loadLocalData() {
            try {
                state.itinerary = JSON.parse(localStorage.getItem('okayama_itin')) || defaultItinerary;
                state.expenses = JSON.parse(localStorage.getItem('okayama_exp')) || [];
                state.members = JSON.parse(localStorage.getItem('okayama_mem')) || defaultMembers;
                state.packing = JSON.parse(localStorage.getItem('okayama_pack')) || defaultPacking;
                state.exchangeRate = parseFloat(localStorage.getItem('okayama_rate')) || 0.22;
            } catch (e) {
                console.warn("è®€å–æœ¬åœ°å„²å­˜å¤±æ•—ï¼Œä½¿ç”¨é è¨­è³‡æ–™", e);
                state.itinerary = defaultItinerary;
                state.expenses = [];
                state.members = defaultMembers;
                state.packing = defaultPacking;
                state.exchangeRate = 0.22;
            }
        }

        function init() {
            // å¼·åˆ¶è§£é™¤æ©Ÿåˆ¶ (Fail-safe)ï¼šç„¡è«–ç™¼ç”Ÿä»€éº¼éŒ¯èª¤ï¼Œ3ç§’å¾Œå¼·åˆ¶éš±è—è¼‰å…¥ç•«é¢
            setTimeout(hideLoading, 3000);

            if (!firebaseConfig.apiKey || firebaseConfig.apiKey.trim() === "") {
                console.log("Local mode (ç„¡ Firebase é‡‘é‘°)");
                hideLoading();
                loadLocalData();
                renderAll();
                return;
            }

            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                setupRealtimeListener();
            } catch (e) {
                console.error("Firebase åˆå§‹åŒ–å¤±æ•—", e);
                hideLoading();
                loadLocalData();
                renderAll(); // é™ç´šä½¿ç”¨æœ¬åœ°æ¨¡å¼
            }
        }

        function setupRealtimeListener() {
            // åŠ å…¥ error callback æ•æ‰æ¬Šé™é˜»æ“‹ç­‰éŒ¯èª¤
            unsubscribe = db.collection('trips').doc('okayama_trip_v1').onSnapshot(
                (doc) => {
                    hideLoading();

                    if (doc.exists) {
                        const data = doc.data();
                        state.itinerary = data.itinerary || [];
                        state.expenses = data.expenses || [];
                        state.members = data.members || defaultMembers;
                        state.packing = data.packing || defaultPacking;
                        state.exchangeRate = data.exchangeRate || 0.22;
                    } else {
                        // åˆå§‹åŒ–é ç«¯è³‡æ–™åº«
                        state.itinerary = defaultItinerary;
                        state.members = defaultMembers;
                        state.packing = defaultPacking;
                        saveData();
                    }
                    
                    renderAll();
                }, 
                (error) => {
                    console.error("Firestore åŒæ­¥éŒ¯èª¤:", error);
                    hideLoading();
                    loadLocalData();
                    renderAll();
                }
            );
        }

        function saveData() {
            if (db) {
                db.collection('trips').doc('okayama_trip_v1').set({
                    itinerary: state.itinerary,
                    expenses: state.expenses,
                    members: state.members,
                    packing: state.packing,
                    exchangeRate: state.exchangeRate
                }).catch(e => console.error("å¯«å…¥ Firebase å¤±æ•—:", e));
            } else {
                try {
                    localStorage.setItem('okayama_itin', JSON.stringify(state.itinerary));
                    localStorage.setItem('okayama_exp', JSON.stringify(state.expenses));
                    localStorage.setItem('okayama_mem', JSON.stringify(state.members));
                    localStorage.setItem('okayama_pack', JSON.stringify(state.packing));
                    localStorage.setItem('okayama_rate', state.exchangeRate);
                } catch(e) {
                    console.warn("å¯«å…¥æœ¬åœ°å„²å­˜å¤±æ•—:", e);
                }
            }
        }

        function renderAll() {
            renderDateSlider();
            renderItinerary();
            renderExpenses();
            renderWeatherPage();
            renderPackingList();
            populateDateSelect();
            populatePayerSelect();
            document.getElementById('settle-rate').value = state.exchangeRate;
            updateWeather(state.currentDate);
        }

        // --- UI Nav & Dates ---
        function switchView(viewName) {
            state.currentView = viewName;
            ['itinerary', 'weather', 'accounting', 'tools'].forEach(v => {
                document.getElementById(`view-${v}`).className = (v === viewName) ? 'block animate-fade-in' : 'hidden';
                const btn = document.getElementById(`nav-${v}`);
                if(btn) {
                    btn.classList.remove('text-terracotta-600');
                    btn.classList.add('text-earth-400');
                }
            });
            
            document.getElementById(`nav-${viewName}`).classList.remove('text-earth-400');
            document.getElementById(`nav-${viewName}`).classList.add('text-terracotta-600');
            
            // Show/Hide FAB & Date Slider based on view
            document.getElementById('main-fab').style.display = (viewName === 'itinerary' || viewName === 'accounting') ? 'flex' : 'none';
            document.getElementById('date-slider-container').style.display = (viewName === 'itinerary' || viewName === 'accounting') ? 'flex' : 'none';
        }

        function renderDateSlider() {
            const container = document.getElementById('date-slider');
            container.innerHTML = '';
            tripDates.forEach(d => {
                const isActive = d.date === state.currentDate;
                const el = document.createElement('div');
                el.className = `date-card flex-shrink-0 w-[4.5rem] h-20 rounded-2xl flex flex-col items-center justify-center cursor-pointer transition-all duration-300 snap-center ${isActive ? 'bg-earth-800 shadow-lg border-2 border-terracotta-500' : 'bg-white text-earth-500 border border-earth-200 hover:bg-earth-50'}`;
                el.innerHTML = `
                    <span class="text-xs font-bold ${isActive ? 'text-earth-200' : ''}">${d.label}</span>
                    <span class="text-lg font-black mt-1 ${isActive ? 'text-white' : 'text-earth-800'}">${d.day}</span>
                `;
                el.onclick = () => {
                    state.currentDate = d.date;
                    renderAll();
                };
                container.appendChild(el);
            });
            
            const found = tripDates.find(t => t.date === state.currentDate);
            if(found) {
                document.getElementById('current-date-display-itin').innerText = `${found.label} (${found.day})`;
                document.getElementById('current-date-display-acc').innerText = `${found.label} (${found.day})`;
            }
        }

        // --- Weather Page & Header ---
        function updateWeather(dateStr) {
            const hash = dateStr.split('').reduce((a,b)=>{a=((a<<5)-a)+b.charCodeAt(0);return a&a},0);
            const temp = 28 + (Math.abs(hash) % 6);
            const conditions = ['fa-sun', 'fa-cloud-sun', 'fa-cloud-showers-heavy'];
            const condIcon = conditions[Math.abs(hash) % 3];
            document.getElementById('weather-temp').innerText = `${temp}Â°C`;
            const headerIcon = document.getElementById('header-weather-icon');
            if (headerIcon) {
                let colorClass = 'text-gray-400';
                if(condIcon === 'fa-sun') colorClass = 'text-orange-500';
                else if(condIcon === 'fa-cloud-sun') colorClass = 'text-orange-400';
                headerIcon.className = `fa-solid ${condIcon} ${colorClass} text-xl`;
            }
        }

        function renderWeatherPage() {
            const container = document.getElementById('weather-cards-container');
            container.innerHTML = '';
            
            tripDates.forEach(d => {
                const w = weatherMockData[d.date];
                const isToday = d.date === state.currentDate;
                const el = document.createElement('div');
                el.className = `p-4 rounded-2xl flex items-center justify-between border ${isToday ? 'bg-white border-terracotta-300 shadow-md' : 'bg-earth-50/50 border-earth-100 shadow-sm'}`;
                el.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-12 text-center">
                            <div class="text-xs font-bold text-earth-500">${d.label}</div>
                            <div class="text-lg font-black text-earth-800">${d.day}</div>
                        </div>
                        <i class="fa-solid ${w.icon} text-3xl ${w.color} w-10 text-center"></i>
                        <div>
                            <div class="font-black text-xl text-earth-900">${w.temp} <span class="text-xs text-earth-500 font-normal">é«”æ„Ÿ ${w.feels}</span></div>
                            <div class="text-[10px] text-earth-500 mt-1">${w.desc}</div>
                        </div>
                    </div>
                    <div class="text-right max-w-[90px]">
                        <div class="text-[10px] bg-sage-100 text-sage-800 px-2 py-1 rounded border border-sage-200 leading-tight">
                            ğŸ‘• ${w.cloth}
                        </div>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        // --- Itinerary ---
        function renderItinerary() {
            const list = document.getElementById('itinerary-list');
            list.innerHTML = '';
            
            // æ ¹æ“šæ™‚é–“é€²è¡Œè‡ªå‹•æ’åº
            const dailyItems = state.itinerary
                .filter(i => i.date === state.currentDate)
                .sort((a, b) => a.time.localeCompare(b.time));

            if (dailyItems.length === 0) {
                document.getElementById('empty-itinerary').classList.remove('hidden');
            } else {
                document.getElementById('empty-itinerary').classList.add('hidden');
                dailyItems.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'relative pl-6 pb-4 group';
                    el.setAttribute('data-id', item.id);
                    
                    const mapLink = item.location ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}` : '#';
                    const cat = catConfig[item.category] || catConfig['attraction'];
                    
                    // Construct detailed info blocks
                    let detailsHtml = '';
                    if(item.duration || item.transportTime) {
                        detailsHtml += `<div class="flex gap-2 mt-2">`;
                        if(item.duration) detailsHtml += `<span class="text-[10px] bg-earth-100 text-earth-600 px-2 py-0.5 rounded"><i class="fa-regular fa-clock mr-1"></i>${item.duration}</span>`;
                        if(item.transportTime) detailsHtml += `<span class="text-[10px] bg-earth-100 text-earth-600 px-2 py-0.5 rounded"><i class="fa-solid fa-car mr-1"></i>${item.transportTime}</span>`;
                        detailsHtml += `</div>`;
                    }
                    if(item.tips) detailsHtml += `<div class="text-[10px] text-terracotta-700 bg-terracotta-50 px-2 py-1 rounded mt-1.5 border border-terracotta-100"><i class="fa-solid fa-star mr-1"></i>${item.tips}</div>`;
                    if(item.parking) detailsHtml += `<div class="text-[10px] text-blue-700 bg-blue-50 px-2 py-1 rounded mt-1.5 border border-blue-100"><i class="fa-solid fa-square-parking mr-1"></i>${item.parking}</div>`;
                    if(item.notes) detailsHtml += `<div class="text-xs text-earth-500 mt-1.5"><i class="fa-regular fa-note-sticky mr-1"></i>${item.notes}</div>`;

                    el.innerHTML = `
                        <div class="absolute -left-[9px] top-4 w-4 h-4 rounded-full bg-white border-4 border-sage-500 z-10 shadow-sm"></div>
                        <div class="bg-white rounded-2xl p-4 shadow-sm border border-earth-100 hover:border-sage-300 transition-colors cursor-pointer" onclick="openEditItinerary(${item.id})">
                            <div class="flex justify-between items-start mb-1">
                                <div class="flex items-center gap-2">
                                    <span class="text-earth-900 font-black text-lg">${item.time}</span>
                                    <span class="${cat.bg} ${cat.color} text-[10px] font-bold px-2 py-0.5 rounded shadow-sm"><i class="fa-solid ${cat.icon} mr-1"></i>${cat.label}</span>
                                </div>
                                <a href="${mapLink}" target="_blank" onclick="event.stopPropagation()" class="text-earth-400 hover:text-terracotta-500 bg-earth-50 p-1.5 rounded-lg"><i class="fa-solid fa-location-arrow"></i></a>
                            </div>
                            <h4 class="font-bold text-earth-800 text-base leading-snug">${item.title}</h4>
                            ${item.location ? `<p class="text-xs text-earth-400 mt-0.5"><i class="fa-solid fa-location-dot mr-1"></i>${item.location}</p>` : ''}
                            ${detailsHtml}
                        </div>`;
                    list.appendChild(el);
                });
            }
        }

        // --- Modals Logic ---
        function handleFabClick() {
            if (state.currentView === 'itinerary') {
                openModal('modal-itinerary');
                document.getElementById('form-itinerary').reset();
                document.getElementById('edit-id').value = '';
                document.getElementById('input-category').value = 'attraction';
                document.getElementById('btn-delete-itinerary').classList.add('hidden');
                document.getElementById('input-time').value = '09:00';
            } else if (state.currentView === 'accounting') {
                populatePayerSelect();
                renderSplitMembers();
                openModal('modal-expense');
                document.getElementById('form-expense').reset();
                document.getElementById('exp-date').value = state.currentDate;
                if(state.members.length > 0) document.getElementById('exp-payer').value = state.members[0];
            }
        }

        function openModal(id) {
            const modal = document.getElementById(id);
            const content = document.getElementById(id + '-content');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                if(content.classList.contains('translate-y-full')) content.classList.remove('translate-y-full');
                else { content.classList.remove('scale-95'); content.classList.add('scale-100'); }
            }, 10);
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            const content = document.getElementById(id + '-content');
            modal.classList.add('opacity-0');
            if(content.classList.contains('scale-100')) { content.classList.remove('scale-100'); content.classList.add('scale-95'); }
            else content.classList.add('translate-y-full');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        // --- Itinerary CRUD ---
        document.getElementById('form-itinerary').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const newItem = {
                id: id ? parseInt(id) : Date.now(),
                date: state.currentDate,
                time: document.getElementById('input-time').value,
                category: document.getElementById('input-category').value,
                title: document.getElementById('input-title').value,
                location: document.getElementById('input-location').value,
                duration: document.getElementById('input-duration').value,
                transportTime: document.getElementById('input-transport').value,
                tips: document.getElementById('input-tips').value,
                parking: document.getElementById('input-parking').value,
                notes: document.getElementById('input-notes').value
            };
            
            if (id) {
                const idx = state.itinerary.findIndex(i => i.id == id);
                if (idx > -1) state.itinerary[idx] = newItem;
            } else {
                state.itinerary.push(newItem);
            }
            saveData(); if(!db) renderItinerary(); closeModal('modal-itinerary');
        });

        function openEditItinerary(id) {
            const item = state.itinerary.find(i => i.id === id);
            if (!item) return;
            document.getElementById('edit-id').value = item.id;
            document.getElementById('input-time').value = item.time;
            document.getElementById('input-category').value = item.category || 'attraction';
            document.getElementById('input-title').value = item.title;
            document.getElementById('input-location').value = item.location || '';
            document.getElementById('input-duration').value = item.duration || '';
            document.getElementById('input-transport').value = item.transportTime || '';
            document.getElementById('input-tips').value = item.tips || '';
            document.getElementById('input-parking').value = item.parking || '';
            document.getElementById('input-notes').value = item.notes || '';
            
            const btnDel = document.getElementById('btn-delete-itinerary');
            btnDel.classList.remove('hidden');
            btnDel.onclick = () => { if(confirm('ç¢ºå®šåˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ')) { state.itinerary = state.itinerary.filter(i => i.id !== id); saveData(); if(!db) renderItinerary(); closeModal('modal-itinerary'); }};
            openModal('modal-itinerary');
        }

        // --- Packing List ---
        function renderPackingList() {
            const container = document.getElementById('packing-lists-container');
            container.innerHTML = '';
            Object.keys(packCatNames).forEach(cat => {
                const items = state.packing.filter(p => p.cat === cat);
                if(items.length === 0) return;
                
                const group = document.createElement('div');
                let html = `<h5 class="text-xs font-bold text-earth-600 mb-2 border-b border-earth-100 pb-1">${packCatNames[cat]}</h5><div class="space-y-2">`;
                
                items.forEach(item => {
                    html += `
                        <div class="flex items-center justify-between bg-earth-50 p-2 rounded-lg border border-earth-100">
                            <label class="flex items-center gap-2 flex-1 cursor-pointer">
                                <input type="checkbox" class="pack-checkbox w-4 h-4 text-sage-600 rounded border-earth-300 focus:ring-sage-500" ${item.checked?'checked':''} onchange="togglePack(${item.id})">
                                <div class="text-sm text-earth-800 font-medium transition-colors">${item.name}</div>
                            </label>
                            <div class="flex items-center gap-3">
                                <span class="text-xs font-bold text-earth-500 bg-white px-2 py-0.5 rounded shadow-sm border border-earth-200">x${item.qty}</span>
                                <button onclick="deletePack(${item.id})" class="text-earth-300 hover:text-red-500"><i class="fa-solid fa-trash-can text-xs"></i></button>
                            </div>
                        </div>`;
                });
                html += `</div>`;
                group.innerHTML = html;
                container.appendChild(group);
            });
        }

        function openPackingModal() { document.getElementById('pack-name').value = ''; openModal('modal-packing'); }
        function addPackingItem() {
            const cat = document.getElementById('pack-category').value;
            const name = document.getElementById('pack-name').value.trim();
            const qty = parseInt(document.getElementById('pack-qty').value) || 1;
            if(name) {
                state.packing.push({ id: Date.now(), cat, name, qty, checked: false });
                saveData(); if(!db) renderPackingList(); closeModal('modal-packing');
            }
        }
        function togglePack(id) { const item = state.packing.find(p=>p.id===id); if(item){ item.checked = !item.checked; saveData(); if(!db)renderPackingList(); } }
        function deletePack(id) { state.packing = state.packing.filter(p=>p.id!==id); saveData(); if(!db)renderPackingList(); }
        function openRulesModal() { openModal('modal-rules'); }

        // --- Expenses & Members ---
        function renderExpenses() {
            const list = document.getElementById('expense-list');
            list.innerHTML = '';
            let totalTWD = 0;
            state.expenses.forEach(exp => {
                const amt = parseInt(exp.amount);
                totalTWD += (exp.currency === 'JPY' ? Math.round(amt * state.exchangeRate) : amt);
            });
            document.getElementById('total-expense-twd').innerText = `NT$ ${totalTWD.toLocaleString()}`;
            document.getElementById('display-rate').innerText = state.exchangeRate;

            const daily = state.expenses.filter(e => e.date === state.currentDate).sort((a,b) => b.id - a.id);
            if (daily.length === 0) document.getElementById('empty-expenses').classList.remove('hidden');
            else {
                document.getElementById('empty-expenses').classList.add('hidden');
                daily.forEach(exp => {
                    const mCount = exp.sharedBy.length;
                    const amt = parseInt(exp.amount);
                    const pp = mCount > 0 ? Math.round(amt / mCount) : 0;
                    const sym = exp.currency === 'JPY' ? 'Â¥' : 'NT$';
                    const payer = exp.payer || (state.members.length>0?state.members[0]:'æœªçŸ¥');
                    
                    const el = document.createElement('div');
                    el.className = 'bg-white p-4 rounded-xl shadow-sm border border-earth-100 flex justify-between items-center';
                    el.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="bg-sage-100 w-10 h-10 rounded-full flex items-center justify-center text-sage-600 flex-shrink-0"><i class="fa-solid fa-file-invoice-dollar"></i></div>
                            <div class="min-w-0">
                                <div class="font-bold text-earth-800 truncate text-sm">${exp.title}</div>
                                <div class="text-[10px] text-earth-500 truncate mt-0.5">${payer}å¢Šä»˜ â€¢ ${mCount}äººåˆ†æ”¤</div>
                            </div>
                        </div>
                        <div class="text-right flex-shrink-0 ml-2">
                            <div class="font-black text-earth-900">${sym} ${amt.toLocaleString()}</div>
                            <div class="text-[10px] text-earth-400 mt-0.5">æ¯äºº ${sym}${pp.toLocaleString()}</div>
                            <button onclick="deleteExpense(${exp.id})" class="text-red-400/70 text-[10px] mt-1 hover:text-red-600"><i class="fa-solid fa-trash mr-1"></i>åˆªé™¤</button>
                        </div>`;
                    list.appendChild(el);
                });
            }
            const avatars = document.getElementById('member-avatars'); avatars.innerHTML = '';
            state.members.slice(0, 5).forEach((m, i) => { // limit display
                const div = document.createElement('div');
                div.className = `w-8 h-8 rounded-full bg-white border-2 border-earth-500 flex items-center justify-center text-[10px] font-bold text-earth-800 shadow-sm`;
                div.innerText = m.charAt(0); avatars.appendChild(div);
            });
            if(state.members.length > 5) {
                const div = document.createElement('div'); div.className = `w-8 h-8 rounded-full bg-earth-200 border-2 border-white flex items-center justify-center text-[10px] font-bold text-earth-800`; div.innerText = `+${state.members.length-5}`; avatars.appendChild(div);
            }
        }

        // Standard accounting functions...
        function populateDateSelect() { const sel = document.getElementById('exp-date'); sel.innerHTML = ''; tripDates.forEach(d => { const opt = document.createElement('option'); opt.value = d.date; opt.text = `${d.label} (${d.day})`; sel.appendChild(opt); }); }
        function populatePayerSelect() { const sel = document.getElementById('exp-payer'); const currentVal = sel.value; sel.innerHTML = ''; state.members.forEach(m => { const opt = document.createElement('option'); opt.value = m; opt.text = m; sel.appendChild(opt); }); if(state.members.includes(currentVal)) sel.value = currentVal; else if(state.members.length > 0) sel.value = state.members[0]; }
        function renderSplitMembers() { const container = document.getElementById('split-members-container'); container.innerHTML = ''; state.members.forEach(m => { const label = document.createElement('label'); label.className = 'flex items-center space-x-2 bg-earth-50 p-2 rounded cursor-pointer select-none border border-earth-200'; label.innerHTML = `<input type="checkbox" value="${m}" checked onchange="updateToggleLabel()" class="form-checkbox text-sage-600 rounded focus:ring-sage-500"><span class="text-xs font-bold text-earth-700">${m}</span>`; container.appendChild(label); }); updateToggleLabel(); }
        function toggleAllMembers() { const checkboxes = document.querySelectorAll('#split-members-container input[type="checkbox"]'); const allChecked = Array.from(checkboxes).every(cb => cb.checked); checkboxes.forEach(cb => cb.checked = !allChecked); updateToggleLabel(); }
        function updateToggleLabel() { const checkboxes = document.querySelectorAll('#split-members-container input[type="checkbox"]'); const allChecked = Array.from(checkboxes).every(cb => cb.checked); document.getElementById('btn-toggle-members').innerText = allChecked ? 'å–æ¶ˆå…¨é¸' : 'å…¨é¸'; }

        document.getElementById('form-expense').addEventListener('submit', (e) => {
            e.preventDefault();
            const checkboxes = document.querySelectorAll('#split-members-container input[type="checkbox"]:checked');
            const sharedBy = Array.from(checkboxes).map(cb => cb.value);
            if (sharedBy.length === 0) { alert('è«‹é¸æ“‡åˆ†å¸³æˆå“¡'); return; }
            state.expenses.push({ id: Date.now(), title: document.getElementById('exp-title').value, payer: document.getElementById('exp-payer').value, amount: document.getElementById('exp-amount').value, currency: document.getElementById('exp-currency').value, date: document.getElementById('exp-date').value, sharedBy });
            saveData(); if(!db) renderExpenses(); closeModal('modal-expense');
        });

        function deleteExpense(id) { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { state.expenses = state.expenses.filter(e => e.id !== id); saveData(); if(!db) renderExpenses(); }}
        function openMemberModal() { renderMembersList(); openModal('modal-members'); }
        function renderMembersList() { const list = document.getElementById('members-list'); list.innerHTML = ''; state.members.forEach((m, i) => { const div = document.createElement('div'); div.className = 'flex justify-between items-center bg-earth-50 p-3 rounded-xl border border-earth-100'; div.innerHTML = `<span class="text-earth-800 font-bold">${m}</span>${state.members.length > 1 ? `<button onclick="removeMember(${i})" class="text-red-400 bg-white px-2 py-1 rounded shadow-sm"><i class="fa-solid fa-trash text-xs"></i></button>` : ''}`; list.appendChild(div); }); }
        function addMember() { const name = document.getElementById('new-member-name').value.trim(); if (name) { state.members.push(name); document.getElementById('new-member-name').value = ''; saveData(); renderMembersList(); populatePayerSelect(); }}
        function removeMember(index) { state.members.splice(index, 1); saveData(); renderMembersList(); populatePayerSelect(); }

        // Settlement
        function openSettlementModal() { document.getElementById('settle-rate').value = state.exchangeRate; renderSettlement(); openModal('modal-settlement'); }
        function saveRateAndCalc() { const newRate = parseFloat(document.getElementById('settle-rate').value); if(newRate > 0) { state.exchangeRate = newRate; saveData(); renderExpenses(); renderSettlement(); } }
        function renderSettlement() {
            const rate = state.exchangeRate; const res = document.getElementById('settlement-results'); let bal = {}; state.members.forEach(m => bal[m] = 0);
            state.expenses.forEach(exp => {
                const amtTWD = exp.currency === 'JPY' ? Math.round(parseInt(exp.amount) * rate) : parseInt(exp.amount);
                const payer = exp.payer || (state.members.length > 0 ? state.members[0] : null);
                if (payer && bal.hasOwnProperty(payer)) bal[payer] += amtTWD;
                if (exp.sharedBy.length > 0) { const split = amtTWD / exp.sharedBy.length; exp.sharedBy.forEach(m => { if(bal.hasOwnProperty(m)) bal[m] -= split; }); }
            });
            let debtors = [], creditors = []; for (const [m, a] of Object.entries(bal)) { if (a < -1) debtors.push({m, a}); if (a > 1) creditors.push({m, a}); }
            debtors.sort((a,b)=>a.a-b.a); creditors.sort((a,b)=>b.a-a.a);
            let tx = [], i=0, j=0;
            while(i < debtors.length && j < creditors.length) {
                let amt = Math.min(Math.abs(debtors[i].a), creditors[j].a);
                tx.push({from: debtors[i].m, to: creditors[j].m, amt});
                debtors[i].a += amt; creditors[j].a -= amt;
                if(Math.abs(debtors[i].a) < 1) i++; if(creditors[j].a < 1) j++;
            }
            res.innerHTML = tx.length === 0 ? `<div class="text-center text-earth-400 py-10"><i class="fa-solid fa-check-circle text-4xl mb-2 text-sage-500"></i><p>å¸³ç›®å·²å¹³è¡¡</p></div>` : '';
            tx.forEach(t => {
                const el = document.createElement('div'); el.className = 'bg-white border border-earth-200 p-4 rounded-xl shadow-sm flex items-center justify-between';
                el.innerHTML = `<div class="flex items-center gap-3"><div class="font-bold text-earth-900 bg-earth-100 px-3 py-1 rounded">${t.from}</div><i class="fa-solid fa-arrow-right text-terracotta-500"></i><div class="font-bold text-earth-900 bg-earth-100 px-3 py-1 rounded">${t.to}</div></div><div class="text-lg font-black text-earth-900">NT$ ${Math.round(t.amt).toLocaleString()}</div>`; res.appendChild(el);
            });
        }

        init();
    </script>
</body>
</html>
